<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0d1117">
<title>ToLife! ‚Äî Your Health Journey</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ===== ToLife! v1.0 Stylesheet ===== */

:root {
  --bg-primary: #0d1117;
  --bg-secondary: #161b22;
  --bg-card: #1c2333;
  --bg-card-hover: #222d3f;
  --bg-input: #0d1117;
  --border: #30363d;
  --border-focus: #58a6ff;
  --text-primary: #e6edf3;
  --text-secondary: #8b949e;
  --text-muted: #6e7681;
  --accent-green: #2ea043;
  --accent-green-soft: rgba(46,160,67,0.15);
  --accent-blue: #58a6ff;
  --accent-blue-soft: rgba(88,166,255,0.12);
  --accent-orange: #d29922;
  --accent-orange-soft: rgba(210,153,34,0.12);
  --accent-red: #f85149;
  --accent-red-soft: rgba(248,81,73,0.12);
  --accent-purple: #bc8cff;
  --accent-purple-soft: rgba(188,140,255,0.12);
  --accent-teal: #3fb9a2;
  --accent-teal-soft: rgba(63,185,162,0.12);
  --shadow: 0 2px 12px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.5);
  --radius: 12px;
  --radius-sm: 8px;
  --radius-xs: 6px;
  --transition: 0.2s ease;
}

[data-theme="light"] {
  --bg-primary: #f0f2f5;
  --bg-secondary: #ffffff;
  --bg-card: #ffffff;
  --bg-card-hover: #f8f9fa;
  --bg-input: #f0f2f5;
  --border: #d0d7de;
  --border-focus: #0969da;
  --text-primary: #1f2328;
  --text-secondary: #57606a;
  --text-muted: #8b949e;
  --accent-green: #1a7f37;
  --accent-green-soft: rgba(26,127,55,0.1);
  --accent-blue: #0969da;
  --accent-blue-soft: rgba(9,105,218,0.08);
  --accent-orange: #bf8700;
  --accent-orange-soft: rgba(191,135,0,0.08);
  --accent-red: #cf222e;
  --accent-red-soft: rgba(207,34,46,0.08);
  --accent-purple: #8250df;
  --accent-purple-soft: rgba(130,80,223,0.08);
  --accent-teal: #0e8a76;
  --accent-teal-soft: rgba(14,138,118,0.08);
  --shadow: 0 1px 8px rgba(0,0,0,0.08);
  --shadow-lg: 0 4px 20px rgba(0,0,0,0.12);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'DM Sans', -apple-system, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  transition: background var(--transition), color var(--transition);
  overflow-x: hidden;
  padding-bottom: 80px;
}

/* ===== HEADER ===== */
.header {
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  padding: 12px 20px;
  position: sticky;
  top: 0;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.header-brand { display: flex; align-items: center; gap: 10px; }

.header-brand h1 {
  font-family: 'Playfair Display', serif;
  font-size: 1.5rem;
  font-weight: 900;
  background: linear-gradient(135deg, var(--accent-green), var(--accent-teal));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.header-brand .lchaim {
  font-size: 0.82rem;
  color: var(--text-muted);
  font-style: italic;
  margin-top: 2px;
}

.header-actions { display: flex; align-items: center; gap: 8px; }

.theme-toggle, .data-btn {
  background: var(--bg-card);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  border-radius: var(--radius-sm);
  padding: 6px 10px;
  cursor: pointer;
  font-size: 0.8rem;
  transition: all var(--transition);
}

.theme-toggle:hover, .data-btn:hover {
  background: var(--bg-card-hover);
  color: var(--text-primary);
}

.version-tag {
  font-size: 0.8rem;
  color: var(--text-muted);
  background: var(--bg-input);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'JetBrains Mono', monospace;
}

/* ===== BOTTOM NAV ===== */
.bottom-nav {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: space-around;
  padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
  z-index: 100;
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  padding: 6px 12px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all var(--transition);
  color: var(--text-muted);
  font-size: 0.88rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  background: none;
  border: none;
}

.nav-item.active { color: var(--accent-green); }
.nav-item:hover { color: var(--text-primary); background: var(--bg-card); }
.nav-icon { font-size: 1.3rem; }

/* ===== PAGES ===== */
.page {
  display: none;
  padding: 16px;
  max-width: 600px;
  margin: 0 auto;
  animation: fadeIn 0.3s ease;
}

.page.active { display: block; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ===== CARDS ===== */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 12px;
  transition: all var(--transition);
}

.card:hover { border-color: var(--border-focus); }

.card-title {
  font-size: 0.9rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}

/* ===== GOAL PROGRESS RING ===== */
.goal-section { text-align: center; padding: 20px 0 10px; }

.progress-ring-container {
  position: relative;
  display: inline-block;
  margin-bottom: 12px;
}

.progress-ring { transform: rotate(-90deg); }
.progress-ring-bg { fill: none; stroke: var(--border); stroke-width: 8; }

.progress-ring-fill {
  fill: none;
  stroke: var(--accent-green);
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dashoffset 1s ease;
}

.progress-center {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

.progress-lbs {
  font-family: 'JetBrains Mono', monospace;
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--accent-green);
}

.progress-label {
  font-size: 0.85rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.goal-subtitle { font-size: 0.92rem; color: var(--text-secondary); }
.goal-subtitle strong { color: var(--text-primary); }

/* ===== STAT GRID ===== */
.stat-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-bottom: 12px;
}

.stat-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
  text-align: center;
}

.stat-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 1.4rem;
  font-weight: 700;
  margin-bottom: 2px;
}

.stat-label {
  font-size: 0.85rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

.stat-green { color: var(--accent-green); }
.stat-blue { color: var(--accent-blue); }
.stat-orange { color: var(--accent-orange); }
.stat-purple { color: var(--accent-purple); }
.stat-teal { color: var(--accent-teal); }
.stat-red { color: var(--accent-red); }

/* ===== CHART ===== */
.chart-container { width: 100%; height: 200px; position: relative; }
.chart-container canvas { width: 100% !important; height: 100% !important; }

/* ===== FORMS ===== */
.form-group { margin-bottom: 14px; }

.form-label {
  display: block;
  font-size: 0.92rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 6px;
}

.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 10px 12px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-xs);
  color: var(--text-primary);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.9rem;
  transition: border var(--transition);
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--border-focus);
}

.form-textarea { resize: vertical; min-height: 60px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

/* ===== SLIDER ===== */
.slider-group { margin-bottom: 14px; }

.slider-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.slider-value {
  font-family: 'JetBrains Mono', monospace;
  font-weight: 700;
  font-size: 1.1rem;
  min-width: 32px;
  text-align: right;
}

input[type="range"] {
  -webkit-appearance: none;
  width: 100%;
  height: 6px;
  border-radius: 3px;
  background: var(--border);
  outline: none;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 22px; height: 22px;
  border-radius: 50%;
  background: var(--accent-green);
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

/* ===== QUICK SELECT ===== */
.quick-select { display: flex; gap: 8px; flex-wrap: wrap; }

.quick-btn {
  padding: 8px 16px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--bg-input);
  color: var(--text-secondary);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.82rem;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition);
}

.quick-btn:hover { border-color: var(--accent-green); color: var(--text-primary); }

.quick-btn.active {
  background: var(--accent-green-soft);
  border-color: var(--accent-green);
  color: var(--accent-green);
}

/* ===== STAR RATING ===== */
.star-rating { display: flex; gap: 6px; }

.star-btn {
  font-size: 1.6rem;
  background: none;
  border: none;
  cursor: pointer;
  color: var(--border);
  transition: color var(--transition), transform 0.15s;
}

.star-btn.filled { color: var(--accent-orange); }
.star-btn:hover { transform: scale(1.15); }

/* ===== BUTTONS ===== */
.btn-primary {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, var(--accent-green), var(--accent-teal));
  color: #fff;
  border: none;
  border-radius: var(--radius-sm);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.95rem;
  font-weight: 700;
  cursor: pointer;
  transition: all var(--transition);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.btn-primary:hover {
  opacity: 0.9;
  transform: translateY(-1px);
  box-shadow: var(--shadow);
}

.btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.btn-secondary {
  width: 100%;
  padding: 10px;
  background: var(--bg-input);
  color: var(--text-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition);
  margin-top: 8px;
}

.btn-secondary:hover { background: var(--bg-card-hover); color: var(--text-primary); }

.btn-small {
  padding: 6px 12px;
  font-size: 0.88rem;
  border-radius: 16px;
  border: 1px solid var(--border);
  background: var(--bg-input);
  color: var(--text-secondary);
  font-family: 'DM Sans', sans-serif;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition);
}

.btn-small:hover { background: var(--bg-card-hover); color: var(--text-primary); }

/* ===== CALORIE BUDGET ===== */
.calorie-budget {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px;
  background: var(--accent-blue-soft);
  border: 1px solid var(--accent-blue);
  border-radius: var(--radius);
  margin-bottom: 12px;
}

.calorie-budget .cb-label { font-size: 0.92rem; color: var(--text-secondary); font-weight: 600; }
.calorie-budget .cb-value { font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; font-weight: 700; color: var(--accent-blue); }
.calorie-budget .cb-detail { font-size: 0.85rem; color: var(--text-muted); }

.calorie-bar-container {
  height: 8px;
  background: var(--border);
  border-radius: 4px;
  overflow: hidden;
  margin-top: 8px;
}

.calorie-bar {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease;
  background: var(--accent-green);
}

.calorie-bar.over { background: var(--accent-red); }

/* ===== AI FOOD ENTRY ===== */
.ai-food-input {
  display: flex;
  gap: 8px;
  margin-bottom: 10px;
}

.ai-food-input input {
  flex: 1;
  padding: 10px 12px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-xs);
  color: var(--text-primary);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.9rem;
}

.ai-food-input input:focus { outline: none; border-color: var(--border-focus); }

.ai-food-input button {
  padding: 10px 16px;
  background: linear-gradient(135deg, var(--accent-blue), var(--accent-teal));
  color: #fff;
  border: none;
  border-radius: var(--radius-xs);
  font-weight: 700;
  cursor: pointer;
  white-space: nowrap;
  font-size: 0.85rem;
  transition: all var(--transition);
}

.ai-food-input button:hover { opacity: 0.9; }
.ai-food-input button:disabled { opacity: 0.5; cursor: not-allowed; }

.ai-result {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px;
  margin-bottom: 10px;
  display: none;
}

.ai-result.visible { display: block; }

.ai-result-item {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  font-size: 0.85rem;
}

.ai-result-item .food-name { color: var(--text-primary); }
.ai-result-item .food-cal { font-family: 'JetBrains Mono'; font-weight: 600; color: var(--accent-orange); }

.ai-result-total {
  display: flex;
  justify-content: space-between;
  padding-top: 8px;
  margin-top: 8px;
  border-top: 1px solid var(--border);
  font-weight: 700;
}

.ai-result-total .total-cal { font-family: 'JetBrains Mono'; color: var(--accent-green); font-size: 1rem; }

.ai-result-macro {
  display: flex;
  gap: 12px;
  margin-top: 6px;
  font-size: 0.88rem;
  color: var(--text-muted);
}

.ai-result-note {
  font-size: 0.85rem;
  color: var(--text-muted);
  font-style: italic;
  margin-top: 6px;
}

.ai-result-actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.ai-result-actions button { flex: 1; }

/* ===== MY FOODS (RECALL) ===== */
.my-foods-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.my-foods-list {
  max-height: 250px;
  overflow-y: auto;
}

.my-food-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
  transition: background var(--transition);
  cursor: pointer;
}

.my-food-item:hover { background: var(--bg-card-hover); }
.my-food-item:last-child { border-bottom: none; }

.my-food-check {
  width: 20px; height: 20px;
  border-radius: 4px;
  border: 2px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all var(--transition);
  font-size: 0.85rem;
  color: transparent;
}

.my-food-item.selected .my-food-check {
  background: var(--accent-green);
  border-color: var(--accent-green);
  color: #fff;
}

.my-food-info { flex: 1; }
.my-food-name { font-size: 0.95rem; font-weight: 500; }
.my-food-cal { font-size: 0.85rem; color: var(--text-muted); font-family: 'JetBrains Mono'; }

.my-food-remove {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  opacity: 0.4;
  font-size: 0.85rem;
  padding: 4px;
  transition: all var(--transition);
}

.my-food-remove:hover { opacity: 1; color: var(--accent-red); }

/* ===== FOOD LOG (today's entries) ===== */
.food-log-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
  font-size: 0.85rem;
}

.food-log-item:last-child { border-bottom: none; }

.food-log-name { flex: 1; color: var(--text-primary); }
.food-log-cal { font-family: 'JetBrains Mono'; font-weight: 600; color: var(--accent-orange); margin-right: 8px; }

.food-log-remove {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  opacity: 0.4;
  font-size: 0.85rem;
  padding: 2px 4px;
  transition: all var(--transition);
}

.food-log-remove:hover { opacity: 1; color: var(--accent-red); }

/* ===== LOG ENTRIES ===== */
.log-entry {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
  transition: background var(--transition);
}

.log-entry:last-child { border-bottom: none; }
.log-entry:hover { background: var(--bg-card-hover); }

.log-date {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  color: var(--text-muted);
  min-width: 65px;
}

.log-detail { flex: 1; margin-left: 10px; font-size: 0.92rem; }

.log-badge {
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 0.82rem;
  font-weight: 700;
  text-transform: uppercase;
}

.badge-weights { background: var(--accent-purple-soft); color: var(--accent-purple); }
.badge-cardio { background: var(--accent-blue-soft); color: var(--accent-blue); }
.badge-stretch { background: var(--accent-teal-soft); color: var(--accent-teal); }
.badge-rest { background: var(--accent-orange-soft); color: var(--accent-orange); }

.log-rpe { font-family: 'JetBrains Mono'; font-weight: 700; font-size: 0.85rem; }

.delete-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 4px;
  font-size: 0.9rem;
  opacity: 0.5;
  transition: all var(--transition);
}

.delete-btn:hover { opacity: 1; color: var(--accent-red); }

/* ===== INSIGHTS ===== */
.insight-card {
  padding: 12px 14px;
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
  font-size: 0.85rem;
  line-height: 1.5;
  display: flex;
  align-items: flex-start;
  gap: 10px;
}

.insight-icon { font-size: 1.2rem; flex-shrink: 0; margin-top: 2px; }

.insight-warn { background: var(--accent-orange-soft); border: 1px solid var(--accent-orange); }
.insight-good { background: var(--accent-green-soft); border: 1px solid var(--accent-green); }
.insight-info { background: var(--accent-blue-soft); border: 1px solid var(--accent-blue); }

/* ===== NUDGE BANNER ===== */
.nudge-banner {
  background: var(--accent-teal-soft);
  border: 1px solid var(--accent-teal);
  border-radius: var(--radius);
  padding: 12px 14px;
  margin-bottom: 12px;
  font-size: 0.85rem;
  line-height: 1.5;
  display: none;
}

.nudge-banner.visible { display: block; }
.nudge-title { font-weight: 700; color: var(--accent-teal); margin-bottom: 4px; }

/* ===== MODAL ===== */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  z-index: 200;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-overlay.active { display: flex; }

.modal {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  max-width: 450px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
}

.modal h3 {
  font-family: 'Playfair Display', serif;
  font-size: 1.2rem;
  margin-bottom: 16px;
}

.modal-actions { display: flex; gap: 10px; margin-top: 16px; }
.modal-actions button { flex: 1; }

/* ===== WEEK GRID ===== */
.week-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
  margin-bottom: 12px;
}

.week-day {
  text-align: center;
  padding: 8px 4px;
  border-radius: var(--radius-xs);
  background: var(--bg-input);
  border: 1px solid var(--border);
}

.week-day-label {
  font-size: 0.78rem;
  font-weight: 700;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 4px;
}

.week-day-icon { font-size: 1.1rem; }
.week-day.completed { border-color: var(--accent-green); background: var(--accent-green-soft); }
.week-day.today { border-color: var(--accent-blue); }

/* ===== TOAST ===== */
.toast {
  position: fixed;
  bottom: 90px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--accent-green);
  color: #fff;
  padding: 10px 24px;
  border-radius: 24px;
  font-weight: 600;
  font-size: 0.85rem;
  z-index: 300;
  transition: transform 0.3s ease, opacity 0.3s ease;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  display: none;
}

.toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
  display: block;
}

/* ===== SPINNER ===== */
.spinner {
  display: inline-block;
  width: 16px; height: 16px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  vertical-align: middle;
  margin-right: 6px;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* ===== RESPONSIVE ===== */
@media (max-width: 400px) {
  .stat-grid { gap: 6px; }
  .header-brand h1 { font-size: 1.2rem; }
  .week-grid { gap: 2px; }
  .week-day { padding: 6px 2px; }
  .ai-food-input { flex-direction: column; }
}

/* === COMPACT LINEAR PROGRESS BAR === */
.progress-linear {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 4px 0;
}
.progress-linear-info {
  display: flex;
  align-items: baseline;
  gap: 8px;
  min-width: 80px;
}
.progress-linear-lbs {
  font-family: 'JetBrains Mono', monospace;
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--accent-green);
}
.progress-linear-unit {
  font-size: 0.85rem;
  color: var(--text-muted);
}
.progress-linear-bar-wrap {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.progress-linear-bar-bg {
  height: 14px;
  background: var(--card-border);
  border-radius: 7px;
  overflow: hidden;
}
.progress-linear-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent-green), var(--accent-teal));
  border-radius: 7px;
  transition: width 0.5s ease;
}
.progress-linear-label {
  font-size: 0.82rem;
  color: var(--text-secondary);
  text-align: right;
}
</style></head><body>
<header class="header">
  <div class="header-brand">
    <div>
      <h1>ü•Ç ToLife!</h1>
      <div class="lchaim">L'Chaim ‚Äî to health, to strength</div>
    </div>
  </div>
  <div class="header-actions">
    <span class="version-tag">v6.0</span>
    <button class="data-btn" onclick="showDataModal()">üíæ</button>
    <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">‚òÄÔ∏è</button>
  </div>
</header>

<div class="toast" id="toast"></div>

<!-- ===== DASHBOARD ===== -->
<div class="page active" id="pageDashboard">
  <div class="nudge-banner" id="nudgeBanner">
    <div class="nudge-title">üíö Gentle Reminder</div>
    <div id="nudgeText"></div>
  </div>
  <div class="card">
    <div class="progress-linear">
      <div class="progress-linear-info">
        <span class="progress-linear-lbs" id="lbsLost">0.0</span>
        <span class="progress-linear-unit">lbs lost</span>
      </div>
      <div class="progress-linear-bar-wrap">
        <div class="progress-linear-bar-bg"><div class="progress-linear-bar-fill" id="progressBar" style="width:0%"></div></div>
        <div class="progress-linear-label" id="goalSubtitle">Week 1 of 8 ‚Äî 21.0 lbs to go</div>
      </div>
    </div>
    <div style="font-size:0.9rem;margin-top:6px;font-weight:500" id="goalPace"></div>
  </div>
  <div id="dashModeBadge" style="text-align:center;padding:4px;font-size:0.85rem;font-weight:600"></div>
  <div id="dashShabbat" style="display:none;text-align:center;padding:8px;margin-bottom:8px;background:var(--bg-input);border-radius:12px;font-size:0.92rem;color:var(--accent-blue)">üïØÔ∏è Shabbat Mode ‚Äî Adjusted targets for today, weekdays will compensate</div>
  <div class="stat-grid">
    <div class="stat-card"><div class="stat-value stat-green" id="dashWeight">179.0</div><div class="stat-label">Current lbs</div></div>
    <div class="stat-card"><div class="stat-value stat-blue" id="dashCalBudget">‚Äî</div><div class="stat-label">Cal Budget</div></div>
    <div class="stat-card"><div class="stat-value stat-orange" id="dashStress">‚Äî</div><div class="stat-label">Stress</div></div>
    <div class="stat-card"><div class="stat-value stat-purple" id="dashWorkout">‚Äî</div><div class="stat-label">Today's RPE</div></div>
  </div>
  <div class="stat-grid">
    <div class="stat-card"><div class="stat-value stat-teal" id="dashConsumed">‚Äî</div><div class="stat-label">Cal Consumed</div></div>
    <div class="stat-card"><div class="stat-value stat-orange" id="dashBurned">‚Äî</div><div class="stat-label">Cal Burned</div></div>
  </div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <span style="font-size:0.88rem;font-weight:600;color:var(--text-secondary)">‚õΩ Daily Fuel Gauge</span>
      <span class="stat-value stat-green" id="dashRemaining" style="font-size:1.1rem">‚Äî</span>
    </div>
    <div style="font-size:0.82rem;color:var(--text-muted);margin-bottom:6px">Budget + Burned ‚àí Consumed = Remaining</div>
    <div class="calorie-bar-container"><div class="calorie-bar" id="dashBalanceBar" style="width:0%"></div></div>
    <div style="display:flex;justify-content:space-between;font-size:0.82rem;color:var(--text-muted);margin-top:4px">
      <span style="color:var(--accent-teal);font-weight:700"><strong id="dashConsumedBar">0</strong> cal consumed</span>
      <span id="dashBalanceLabel">‚Äî remaining</span>
    </div>
    <div style="display:flex;justify-content:space-around;margin-top:10px;padding-top:10px;border-top:1px solid var(--card-border)" id="dashMacros">
      <span style="font-size:0.88rem;color:var(--text-secondary)">ü•© <strong id="dashProtein">0</strong>g protein</span>
      <span style="font-size:0.88rem;color:var(--text-secondary)">üçû <strong id="dashCarbs">0</strong>g carbs</span>
      <span style="font-size:0.88rem;color:var(--text-secondary)">üßà <strong id="dashFat">0</strong>g fat</span>
    </div>
  </div>
  <div class="card">
    <div class="card-title">üìÖ This Week</div>
    <div class="week-grid" id="weekGrid"></div>
  </div>

  <div id="insightsContainer"></div>
</div>

<!-- ===== CHECK-IN ===== -->
<div class="page" id="pageCheckin">
  <div class="card">
    <div class="card-title">üåÖ Daily Check-In</div>
    <div class="form-group">
      <label class="form-label">‚öñÔ∏è Morning Weight (lbs)</label>
      <input type="number" step="0.1" class="form-input" id="checkinWeight" placeholder="178.0">
    </div>
    <div class="form-group">
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
        <input type="checkbox" id="shabbatToggle" style="width:20px;height:20px;accent-color:var(--accent-blue)">
        <span class="form-label" style="margin:0">üïØÔ∏è Shabbat / Special Occasion</span>
      </label>
      <div style="font-size:0.85rem;color:var(--text-muted);margin-top:4px;margin-left:30px">
        Today: +400 cal for meal ¬∑ Tomorrow: auto-sets rest day ¬∑ Remaining days compensate
      </div>
    </div>
    <div class="slider-group">
      <div class="slider-header"><span class="form-label" style="margin:0">üò§ Stress Level</span><span class="slider-value" id="stressVal" style="color:var(--accent-green)">3</span></div>
      <input type="range" id="stressSlider" min="1" max="10" value="3" oninput="updateSlider('stress')">
      <div style="display:flex;justify-content:space-between;font-size:0.85rem;color:var(--text-muted);margin-top:4px"><span>Calm</span><span>Moderate</span><span>Very High</span></div>
    </div>
    <div class="form-group">
      <label class="form-label">üò¥ Sleep Quality</label>
      <div class="star-rating" id="sleepStars">
        <button class="star-btn" data-val="1" onclick="setSleep(1)">‚òÖ</button>
        <button class="star-btn" data-val="2" onclick="setSleep(2)">‚òÖ</button>
        <button class="star-btn" data-val="3" onclick="setSleep(3)">‚òÖ</button>
        <button class="star-btn" data-val="4" onclick="setSleep(4)">‚òÖ</button>
        <button class="star-btn" data-val="5" onclick="setSleep(5)">‚òÖ</button>
      </div>
    </div>
    <div class="slider-group">
      <div class="slider-header"><span class="form-label" style="margin:0">‚ö° Energy & Motivation</span><span class="slider-value" id="energyVal" style="color:var(--accent-orange)">3</span></div>
      <input type="range" id="energySlider" min="1" max="5" value="3" oninput="updateSlider('energy')">
      <div style="display:flex;justify-content:space-between;font-size:0.85rem;color:var(--text-muted);margin-top:4px"><span>Dragging</span><span>Moderate</span><span>Fired Up</span></div>
    </div>
    <div class="form-group">
      <label class="form-label">üìù Optional Note</label>
      <textarea class="form-textarea" id="checkinNote" placeholder="e.g., work deadline, slept poorly, feeling great..." rows="2"></textarea>
    </div>
    <button class="btn-primary" onclick="saveCheckin()">Save Check-In</button>
  </div>
  <div class="card">
    <div class="card-title">üî• Today's Calorie Budget</div>
    <div class="form-group">
      <label class="form-label">Activity Level Today</label>
      <div class="quick-select" id="activitySelect">
        <button class="quick-btn" onclick="setActivity('rest')">üõã Rest</button>
        <button class="quick-btn" onclick="setActivity('light')">üö∂ Light</button>
        <button class="quick-btn active" onclick="setActivity('moderate')">üí™ Moderate</button>
        <button class="quick-btn" onclick="setActivity('intense')">üî• Intense</button>
      </div>
    </div>
    <div class="calorie-budget">
      <div>
        <div class="cb-label">Adjusted Target</div>
        <div class="cb-value" id="calTarget">1,670</div>
        <div class="cb-detail" id="calDetail">TDEE 2,420 ‚àí 750 deficit (with 5% adjustments)</div>
      </div>
    </div>
    <div style="text-align:center;margin:10px 0">
      <span style="font-family:'JetBrains Mono';font-size:1.2rem;font-weight:700;color:var(--accent-orange)" id="calConsumed">0</span>
      <span style="font-size:0.88rem;color:var(--text-muted)"> cal consumed today</span>
    </div>
    <div class="calorie-bar-container"><div class="calorie-bar" id="calorieBar" style="width:0%"></div></div>
    <div style="display:flex;justify-content:space-between;font-size:0.82rem;color:var(--text-muted);margin-top:4px">
      <span id="macroSummary">ü•© 0g protein ¬∑ üçû 0g carbs</span>
      <span id="calRemaining">‚Äî remaining</span>
    </div>
    <div class="form-group" style="margin-top:14px">
      <label class="form-label">End-of-Day: How did you do?</label>
      <div class="quick-select" id="adherenceSelect">
        <button class="quick-btn" onclick="setAdherence('great')">üòä Great</button>
        <button class="quick-btn" onclick="setAdherence('good')">‚úÖ Good</button>
        <button class="quick-btn" onclick="setAdherence('ok')">‚ö†Ô∏è OK</button>
        <button class="quick-btn" onclick="setAdherence('poor')">‚ùå Poor</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== NUTRITION ===== -->
<div class="page" id="pageNutrition">
  <div class="card">
    <div class="card-title">ü§ñ AI Calorie Estimator</div>
    <p style="font-size:0.95rem;color:var(--text-secondary);margin-bottom:12px">Describe what you ate in plain language. Estimates include +5% conservative adjustment.</p>
    <div class="ai-food-input">
      <input type="text" id="foodInput" placeholder="e.g., bowl of multigrain Cheerios with almond milk">
      <button id="estimateBtn" onclick="estimateCalories()">üîç Estimate</button>
    </div>
    <div class="ai-result" id="aiResult"></div>
  </div>
  <div class="card">
    <div class="my-foods-header">
      <div class="card-title" style="margin:0">‚≠ê My Foods & Meals ‚Äî Tap to select, add to today</div>
    </div>
    <div class="my-foods-list" id="myFoodsList"></div>
    <button class="btn-primary" id="addSelectedBtn" onclick="addSelectedMyFoods()" style="display:none;margin-top:10px;font-size:0.85rem;padding:10px">‚úÖ Add Selected</button>
  </div>
  <div class="card">
    <div class="card-title">üìã Today's Food Log</div>
    <div id="foodLogList"></div>
  </div>
</div>

<!-- ===== WORKOUT ===== -->
<div class="page" id="pageWorkout">
  <div class="card">
    <div class="card-title">üö∂ Quick Log: Walking</div>
    <div style="display:flex;gap:8px;align-items:center">
      <input type="number" class="form-input" id="walkingSteps" placeholder="Steps" oninput="updateWalkingEstimate()" style="flex:1;min-width:0;font-size:1rem">
      <select id="walkingRPE" onchange="updateWalkingEstimate()" style="padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg-input);color:var(--text-primary);font-size:0.9rem;font-family:'DM Sans',sans-serif">
        <option value="1">RPE 1</option>
        <option value="2" selected>RPE 2</option>
        <option value="3">RPE 3</option>
        <option value="4">RPE 4</option>
        <option value="5">RPE 5</option>
      </select>
      <button class="btn-primary" onclick="logWalking()" style="width:auto;flex:0 0 auto;margin:0;padding:8px 24px;font-size:0.85rem">Log</button>
    </div>
    <div style="font-size:0.88rem;margin-top:4px;font-weight:500" id="walkingEstimate"></div>
  </div>

  <div class="card">
    <div class="card-title">üèãÔ∏è Log Workout</div>
    <div class="form-group">
      <label class="form-label">Workout Type</label>
      <div class="quick-select" id="workoutTypeSelect">
        <button class="quick-btn" onclick="setWorkoutType('weights')">üèãÔ∏è Weights</button>
        <button class="quick-btn" onclick="setWorkoutType('cardio')">üö¥ Cardio</button>
        <button class="quick-btn" onclick="setWorkoutType('stretch')">üßò Stretch</button>
        <button class="quick-btn" onclick="setWorkoutType('rest')">üõã Rest Day</button>
      </div>
    </div>
    <div class="slider-group" id="rpeSection">
      <div class="slider-header"><span class="form-label" style="margin:0">üí™ Effort (RPE)</span><span class="slider-value" id="rpeVal" style="color:var(--accent-purple)">5</span></div>
      <input type="range" id="rpeSlider" min="1" max="10" value="5" oninput="updateSlider('rpe')">
      <div style="display:flex;justify-content:space-between;font-size:0.85rem;color:var(--text-muted);margin-top:4px"><span>Easy</span><span>Moderate</span><span>Max Effort</span></div>
    </div>
    <div class="form-group" id="durationSection" style="display:none">
      <label class="form-label">‚è± Duration (minutes)</label>
      <input type="number" class="form-input" id="workoutDuration" placeholder="30" oninput="updateBurnEstimate()">
    </div>
    <div class="form-group" id="cardioFocusSection" style="display:none">
      <label class="form-label">üéØ Cardio Focus</label>
      <div class="quick-select">
        <button class="quick-btn" id="btnFatBurn" onclick="setCardioFocus('fatburn')">üî• Fat Burn (longer, moderate)</button>
        <button class="quick-btn" id="btnIntensity" onclick="setCardioFocus('intensity')">üíì Cardio Health (shorter, intense)</button>
      </div>
    </div>
    <div class="form-group" id="hrSection">
      <label class="form-label">‚ù§Ô∏è Heart Rate (optional)</label>
      <input type="number" class="form-input" id="workoutHR" placeholder="e.g., 135">
    </div>
    <div class="form-group" id="burnSection">
      <div style="font-size:0.9rem;color:var(--accent-orange);font-style:italic;margin-bottom:6px" id="burnEstimate"></div>
      <label class="form-label">üî• Calories Burned (optional ‚Äî leave blank to use AI estimate)</label>
      <input type="number" class="form-input" id="workoutCalsBurned" placeholder="e.g., 320 from bike display" oninput="updateBurnEstimate()">
    </div>
    <div class="form-group">
      <label class="form-label">üìù Notes (optional)</label>
      <textarea class="form-textarea" id="workoutNote" placeholder="e.g., chest & shoulders, HIIT intervals..." rows="2"></textarea>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn-primary" onclick="saveWorkout()" style="flex:1">Log Workout</button>
      <button class="btn-secondary" onclick="saveToMyWorkouts()" style="flex:0;white-space:nowrap;font-size:0.8rem">‚≠ê Save</button>
    </div>
  </div>
  <div class="card">
    <div class="card-title">‚≠ê My Workouts ‚Äî Quick Log or Edit & Log</div>
    <div id="myWorkoutsList"></div>
  </div>

  <div class="card">
    <div class="card-title">üìã Last 7 Days ‚Äî Workouts</div>
    <div id="workoutHistory"></div>
  </div>
</div>

<!-- ===== WEIGHT ===== -->


<!-- ===== INSIGHTS ===== -->
<div class="page" id="pageInsights">
  <div class="card" id="goalEditor"></div>
  <div class="card">
    <div class="card-title">üìä Metabolic Profile</div>
    <div class="stat-grid">
      <div class="stat-card"><div class="stat-value stat-teal" id="bmrValue">1,770</div><div class="stat-label">BMR (cal/day)</div></div>
      <div class="stat-card"><div class="stat-value stat-blue" id="tdeeValue">2,420</div><div class="stat-label">TDEE (moderate)</div></div>
    </div>
    <div style="font-size:0.88rem;color:var(--text-secondary);line-height:1.8;padding:8px 0">
      <strong>Daily Calorie Targets</strong> (with 5% conservative adjustments):<br>
      üõã Rest: <span id="calRest" style="font-family:'JetBrains Mono';font-weight:700">1,250</span> cal &nbsp;|&nbsp;
      üö∂ Light: <span id="calLight" style="font-family:'JetBrains Mono';font-weight:700">1,480</span> cal<br>
      üí™ Moderate: <span id="calModerate" style="font-family:'JetBrains Mono';font-weight:700">1,670</span> cal &nbsp;|&nbsp;
      üî• Intense: <span id="calIntense" style="font-family:'JetBrains Mono';font-weight:700">1,860</span> cal
    </div>
  </div>
  <div class="card">
    <div class="card-title">üìâ Weight Trend</div>
    <div id="weightChartSummary" style="margin-bottom:10px;padding:10px;background:var(--bg-input);border-radius:8px"></div>
    <div class="chart-container"><canvas id="weightChart"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">üìà 7-Day Rolling Average</div>
    <div class="stat-grid">
      <div class="stat-card"><div class="stat-value stat-green" id="avg7day">‚Äî</div><div class="stat-label">7-Day Avg</div></div>
      <div class="stat-card"><div class="stat-value stat-blue" id="weeklyChange">‚Äî</div><div class="stat-label">Weekly Œî</div></div>
    </div>
  </div>
  <div class="card"><div class="card-title">üìã Weight History</div><div id="weightHistory"></div></div>
  <div class="card">
    <div class="card-title">üß† Weekly Summary</div>
    <div class="stat-grid">
      <div class="stat-card"><div class="stat-value stat-green" id="insWeightChange">‚Äî</div><div class="stat-label">Weight Œî</div></div>
      <div class="stat-card"><div class="stat-value stat-purple" id="insAvgRPE">‚Äî</div><div class="stat-label">Avg RPE</div></div>
      <div class="stat-card"><div class="stat-value stat-orange" id="insAvgStress">‚Äî</div><div class="stat-label">Avg Stress</div></div>
      <div class="stat-card"><div class="stat-value stat-blue" id="insWorkouts">‚Äî</div><div class="stat-label">Workouts</div></div>
    </div>
  </div>
  <div class="card"><div class="card-title">üîó Stress‚ÄìBehavior Patterns</div><div id="correlationInsights"></div><div id="noInsightsMsg" style="font-size:0.92rem;color:var(--text-muted);padding:8px 0">Log at least 7 days to see patterns.</div></div>
  <div class="card"><div class="card-title">üí° Adaptive Suggestions</div><div id="adaptiveSuggestions"></div></div>
  <div class="card">
    <div class="card-title">üî• Streak</div>
    <div class="stat-grid">
      <div class="stat-card"><div class="stat-value stat-orange" id="currentStreak">0</div><div class="stat-label">Current Days</div></div>
      <div class="stat-card"><div class="stat-value stat-teal" id="bestStreak">0</div><div class="stat-label">Best Streak</div></div>
    </div>
  </div>
</div>

<!-- DATA MODAL -->
<div class="modal-overlay" id="dataModal">
  <div class="modal">
    <h3>üíæ Data Management</h3>
    <button class="btn-primary" onclick="exportData()" style="margin-bottom:8px">üì§ Export JSON</button>
    <button class="btn-secondary" onclick="document.getElementById('importFile').click()">üì• Import JSON</button>
    <input type="file" id="importFile" accept=".json,.txt,*/*" style="display:none" onchange="importData(event)">
    <button class="btn-secondary" onclick="resetAllData()" style="color:var(--accent-red);border-color:var(--accent-red);margin-top:16px">üóë Reset All Data</button>
    <button class="btn-secondary" onclick="closeDataModal()">Close</button>
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-item active" onclick="showPage('Dashboard')"><span class="nav-icon">üè†</span><span>Home</span></button>
  <button class="nav-item" onclick="showPage('Checkin')"><span class="nav-icon">üåÖ</span><span>Check-In</span></button>
  <button class="nav-item" onclick="showPage('Nutrition')"><span class="nav-icon">üçΩ</span><span>Food</span></button>
  <button class="nav-item" onclick="showPage('Workout')"><span class="nav-icon">üèãÔ∏è</span><span>Workout</span></button>
  <button class="nav-item" onclick="showPage('Insights')"><span class="nav-icon">üß†</span><span>Insights</span></button>
</nav>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script><script>
// ===== ToLife! v6.0 ‚Äî App Logic =====
// L'Chaim ‚Äî to health, to strength

const CONFIG = {
  height: 68, startWeight: 179, goalWeight: 158, goalWeeks: 8,
  deficitPerDay: 750, intakeAdjust: 1.05, expendAdjust: 0.95,
  age: 55, gender: 'male',
  workerUrl: 'https://tolife.shawn-cohenmd.workers.dev' // Set to your Cloudflare Worker URL for AI calorie estimation
};

let data = {
  weights: [], workouts: [], checkins: [], calories: [], myFoods: [], myWorkouts: [], myMeals: [], startDate: null
};

const STORAGE_KEY = 'tolife_data';

function loadData() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) { const p = JSON.parse(saved); data = { ...data, ...p }; if (!data.myFoods) data.myFoods = []; if (!data.myWorkouts) data.myWorkouts = []; if (!data.myMeals) data.myMeals = [];
    if (!data.goal) data.goal = { startWeight: 179, goalWeight: 158, goalWeeks: 8, startDate: data.startDate, mode: 'loss' };
    if (!data.profile) data.profile = { height: 68, age: 50 }; }
  if (!data.startDate) { data.startDate = today(); saveData(); }
}

function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
function today() { const d=new Date(); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); }
function formatDate(d) { return new Date(d + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
function daysBetween(a, b) { return Math.floor((new Date(b) - new Date(a)) / 86400000); }
function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 5); }
function showToast(msg) {
  const t = document.getElementById('toast');
  if (window._toastTimer) { clearTimeout(window._toastTimer); window._toastTimer = null; }
  if (window._toastDelay) { clearTimeout(window._toastDelay); window._toastDelay = null; }
  t.classList.remove('show');
  t.style.display = 'none';
  window._toastDelay = setTimeout(() => {
    t.textContent = msg;
    t.style.display = '';
    t.classList.add('show');
    window._toastTimer = setTimeout(() => {
      t.classList.remove('show');
      setTimeout(() => { t.style.display = 'none'; }, 300);
    }, 2500);
  }, 50);
}

function calcBMR(w) { const kg = w * 0.453592, cm = CONFIG.height * 2.54; return Math.round(10 * kg + 6.25 * cm - 5 * CONFIG.age + 5); }
function calcTDEE(w, level) { const m = { rest: 1.2, light: 1.35, moderate: 1.45, intense: 1.55 }; return Math.round(calcBMR(w) * (m[level] || 1.45) * CONFIG.expendAdjust); }
function calcTarget(w, level) { return Math.round(calcTDEE(w, level) - CONFIG.deficitPerDay); }
function getCurrentWeight() { if (!data.weights.length) return CONFIG.startWeight; return [...data.weights].sort((a, b) => b.date.localeCompare(a.date))[0].weight; }

// ===== CALORIES BURNED ESTIMATION =====
function estimateBurn(type, duration, rpe, weight) {
  // MET-based estimation with RPE adjustment
  // MET values: rest=1, stretch/yoga=2.5, weights=3-6 (by RPE), cardio=5-10 (by RPE)
  const kg = weight * 0.453592;
  let met;
  if (type === 'rest') return 0;
  if (type === 'stretch') met = 2.5;
  else if (type === 'weights') met = 2.5 + (rpe / 10) * 4; // 2.5-6.5
  else if (type === 'cardio') met = 4 + (rpe / 10) * 7; // 4-11
  else met = 3;

  // If no duration specified, estimate: weights=45min, cardio=30min, stretch=20min
  const mins = duration || (type === 'weights' ? 45 : type === 'cardio' ? 30 : 20);
  const cals = Math.round((met * kg * mins) / 60);
  // Apply conservative -5% adjustment (we tend to overestimate burn)
  return Math.round(cals * CONFIG.expendAdjust);
}

function getTodayBurned() {
  return data.workouts.filter(w => w.date === today())
    .reduce((sum, w) => sum + (w.calsBurned || 0), 0);
}

function updateMetabolicDisplay() {
  const w = getCurrentWeight();
  document.getElementById('bmrValue').textContent = calcBMR(w).toLocaleString();
  document.getElementById('tdeeValue').textContent = calcTDEE(w, 'moderate').toLocaleString();
  ['rest','light','moderate','intense'].forEach(l => {
    const el = document.getElementById('cal' + l.charAt(0).toUpperCase() + l.slice(1));
    if (el) el.textContent = calcTarget(w, l).toLocaleString();
  });
}

function toggleTheme() {
  const html = document.documentElement;
  const isDark = !html.hasAttribute('data-theme');
  html.toggleAttribute('data-theme', isDark);
  if (isDark) html.setAttribute('data-theme', 'light');
  document.getElementById('themeBtn').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
  localStorage.setItem('tolife_theme', isDark ? 'light' : 'dark');
  if (weightChart) renderWeightChart();
}

function loadTheme() {
  if (localStorage.getItem('tolife_theme') === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
    document.getElementById('themeBtn').textContent = 'üåô';
  }
}

function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page' + name).classList.add('active');
  event.currentTarget.classList.add('active');
  if (name === 'Dashboard') refreshDashboard();
  if (name === 'Insights') { refreshInsights(); renderGoalEditor(); updateMetabolicDisplay(); renderWeightChart(); renderWeightHistory(); renderWeightStats(); }
  if (name === 'Workout') { renderWorkoutHistory(); renderMyWorkouts(); }
  if (name === 'Nutrition') { renderMyFoods(); renderFoodLog(); updateCalorieSummary(); }
}

// ===== CHECK-IN =====
let currentSleep = 0, currentActivity = 'moderate', currentAdherence = '';

function updateSlider(type) {
  const map = {
    stress: { id: 'stressSlider', valId: 'stressVal', colors: ['var(--accent-green)','var(--accent-green)','var(--accent-green)','var(--accent-orange)','var(--accent-orange)','var(--accent-orange)','var(--accent-orange)','var(--accent-red)','var(--accent-red)','var(--accent-red)'] },
    energy: { id: 'energySlider', valId: 'energyVal', colors: null },
    rpe: { id: 'rpeSlider', valId: 'rpeVal', colors: ['var(--accent-teal)','var(--accent-teal)','var(--accent-green)','var(--accent-green)','var(--accent-blue)','var(--accent-blue)','var(--accent-orange)','var(--accent-orange)','var(--accent-red)','var(--accent-red)'], onUpdate: updateBurnEstimate }
  };
  const s = map[type]; const v = document.getElementById(s.id).value;
  const el = document.getElementById(s.valId); el.textContent = v;
  if (s.colors) el.style.color = s.colors[v - 1];
  if (s.onUpdate) s.onUpdate();
}

function setSleep(val) {
  currentSleep = val;
  document.querySelectorAll('#sleepStars .star-btn').forEach(btn => btn.classList.toggle('filled', parseInt(btn.dataset.val) <= val));
}

function setActivity(level) {
  currentActivity = level;
  document.querySelectorAll('#activitySelect .quick-btn').forEach(b => b.classList.remove('active'));
  event.currentTarget.classList.add('active');
  const w = getCurrentWeight();
  document.getElementById('calTarget').textContent = calcTarget(w, level).toLocaleString();
  document.getElementById('calDetail').textContent = 'TDEE ' + calcTDEE(w, level).toLocaleString() + ' ‚àí ' + CONFIG.deficitPerDay + ' deficit (with 5% adjustments)';
  updateCalorieSummary();
}

function setAdherence(val) {
  currentAdherence = val;
  document.querySelectorAll('#adherenceSelect .quick-btn').forEach(b => b.classList.remove('active'));
  event.currentTarget.classList.add('active');
}

function saveCheckin() {
  const stress = parseInt(document.getElementById('stressSlider').value);
  const energy = parseInt(document.getElementById('energySlider').value);
  const note = document.getElementById('checkinNote').value.trim();
  const shabbatMode = document.getElementById('shabbatToggle') ? document.getElementById('shabbatToggle').checked : false;
  // Save weight if entered
  const checkinW = parseFloat(document.getElementById('checkinWeight').value);
  if (checkinW && checkinW >= 100 && checkinW <= 400) {
    data.weights = data.weights.filter(e => e.date !== today());
    data.weights.push({ date: today(), weight: checkinW });
    document.getElementById('checkinWeight').value = '';
  }
  data.checkins = data.checkins.filter(c => c.date !== today());
  data.checkins.push({ date: today(), stress, sleep: currentSleep, energy, note, shabbat: shabbatMode });
  // Update calorie entry WITHOUT destroying existing food log
  const w = getCurrentWeight();
  let target = calcTarget(w, currentActivity);
  // Shabbat / Special Day: cascading 2-day adjustment + weekly compensation
  if (shabbatMode) {
    // TODAY: +400 cal for big meal
    target += 400;

    // TOMORROW: auto-set as rest day with reduced target
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomStr = tomorrow.getFullYear()+'-'+String(tomorrow.getMonth()+1).padStart(2,'0')+'-'+String(tomorrow.getDate()).padStart(2,'0');
    const tomTarget = calcTarget(w, 'rest');
    const tomExisting = data.calories.find(c => c.date === tomStr);
    if (tomExisting) {
      tomExisting.target = tomTarget;
      tomExisting.shabbat = true;
      tomExisting.activity = 'rest';
    } else {
      data.calories.push({ date: tomStr, activity: 'rest', target: tomTarget, shabbat: true, consumed: 0, adherence: '', log: [] });
    }
    // Pre-set tomorrow's checkin as rest/shabbat
    if (!data.checkins.find(c => c.date === tomStr)) {
      data.checkins.push({ date: tomStr, stress: 2, sleep: 4, energy: 3, note: 'Rest day (auto-set)', shabbat: true });
    } else {
      const tomC = data.checkins.find(c => c.date === tomStr);
      tomC.shabbat = true;
    }
  }

  // Weekly compensation: calculate total extra from Shabbat/special days and spread across remaining normal days
  const weekStart = new Date(); weekStart.setDate(weekStart.getDate() - weekStart.getDay());
  const wsStr = weekStart.getFullYear()+'-'+String(weekStart.getMonth()+1).padStart(2,'0')+'-'+String(weekStart.getDate()).padStart(2,'0');
  const weekEnd = new Date(weekStart); weekEnd.setDate(weekEnd.getDate() + 7);
  const weStr = weekEnd.getFullYear()+'-'+String(weekEnd.getMonth()+1).padStart(2,'0')+'-'+String(weekEnd.getDate()).padStart(2,'0');
  // Find all shabbat/special days this week (including today if just toggled, and tomorrow if auto-set)
  const specialDays = data.calories.filter(c => c.date >= wsStr && c.date < weStr && c.shabbat);
  if (!shabbatMode && specialDays.length > 0) {
    // Total extra calories granted on special days
    const totalExtra = specialDays.reduce((sum, c) => {
      const baseTarget = calcTarget(w, c.activity === 'rest' ? 'rest' : 'moderate');
      const extra = c.target - baseTarget;
      return sum + (extra > 0 ? extra : 0);
    }, 0);
    // Count remaining non-special days in week (including today)
    const todayDow = new Date().getDay();
    let normalDaysLeft = 0;
    for (let d = todayDow; d < 7; d++) {
      const checkDate = new Date(weekStart);
      checkDate.setDate(checkDate.getDate() + d);
      const cdStr = checkDate.getFullYear()+'-'+String(checkDate.getMonth()+1).padStart(2,'0')+'-'+String(checkDate.getDate()).padStart(2,'0');
      if (!specialDays.find(s => s.date === cdStr)) normalDaysLeft++;
    }
    if (normalDaysLeft > 0 && totalExtra > 0) {
      const dailyComp = Math.round(totalExtra / normalDaysLeft);
      target = Math.max(target - dailyComp, 1200);
    }
  }
  const existing = data.calories.find(c => c.date === today());
  if (existing) {
    existing.activity = currentActivity;
    existing.target = target;
    existing.shabbat = shabbatMode;
    existing.adherence = currentAdherence;
    existing.consumed = existing.log ? existing.log.reduce((s, f) => s + f.calories, 0) : 0;
  } else {
    data.calories.push({ date: today(), activity: currentActivity, target, shabbat: shabbatMode, consumed: 0, adherence: currentAdherence, log: [] });
  }
  saveData(); showToast('‚úÖ Check-in saved!'); refreshDashboard();
}

// ===== WORKOUT =====
let currentWorkoutType = '', currentCardioFocus = '';

function setWorkoutType(type) {
  currentWorkoutType = type;
  document.querySelectorAll('#workoutTypeSelect .quick-btn').forEach(b => b.classList.remove('active'));
  event.currentTarget.classList.add('active');
  document.getElementById('durationSection').style.display = (type === 'cardio' || type === 'stretch') ? 'block' : 'none';
  document.getElementById('cardioFocusSection').style.display = type === 'cardio' ? 'block' : 'none';
  document.getElementById('rpeSection').style.display = type === 'rest' ? 'none' : 'block';
  document.getElementById('hrSection').style.display = type === 'rest' ? 'none' : 'block';
  document.getElementById('burnSection').style.display = type === 'rest' ? 'none' : 'block';
  updateBurnEstimate();
}

function updateBurnEstimate() {
  if (!currentWorkoutType || currentWorkoutType === 'rest') { document.getElementById('burnEstimate').textContent = ''; return; }
  const rpe = parseInt(document.getElementById('rpeSlider').value) || 5;
  const duration = parseInt(document.getElementById('workoutDuration').value) || 0;
  const w = getCurrentWeight();
  const est = estimateBurn(currentWorkoutType, duration, rpe, w);
  document.getElementById('burnEstimate').textContent = 'AI estimate: ~' + est + ' cal (override below if your machine shows different)';
}

function setCardioFocus(focus) {
  currentCardioFocus = focus;
  document.getElementById('btnFatBurn').classList.toggle('active', focus === 'fatburn');
  document.getElementById('btnIntensity').classList.toggle('active', focus === 'intensity');
}

function saveWorkout() {
  if (!currentWorkoutType) { showToast('‚ö†Ô∏è Select a workout type'); return; }
  const rpe = currentWorkoutType !== 'rest' ? parseInt(document.getElementById('rpeSlider').value) : 0;
  const duration = parseInt(document.getElementById('workoutDuration').value) || 0;
  const manualBurn = parseInt(document.getElementById('workoutCalsBurned').value) || 0;
  const w = getCurrentWeight();
  const calsBurned = manualBurn > 0 ? manualBurn : estimateBurn(currentWorkoutType, duration, rpe, w);

  data.workouts.push({
    date: today(), type: currentWorkoutType, rpe, duration,
    focus: currentCardioFocus, hr: parseInt(document.getElementById('workoutHR').value) || 0,
    note: document.getElementById('workoutNote').value.trim(),
    calsBurned
  });
  saveData();
  document.getElementById('workoutDuration').value = '';
  document.getElementById('workoutHR').value = '';
  document.getElementById('workoutNote').value = '';
  document.getElementById('workoutCalsBurned').value = '';
  showToast('üí™ Workout logged! ' + calsBurned + ' cal burned'); renderWorkoutHistory(); renderMyWorkouts(); refreshDashboard();
}

function renderWorkoutHistory() {
  const c = document.getElementById('workoutHistory');
  const sevenAgo = new Date(); sevenAgo.setDate(sevenAgo.getDate() - 7);
  const sevenAgoStr = sevenAgo.getFullYear()+'-'+String(sevenAgo.getMonth()+1).padStart(2,'0')+'-'+String(sevenAgo.getDate()).padStart(2,'0');
  const recent = [...data.workouts].filter(w => w.date >= sevenAgoStr).sort((a, b) => b.date.localeCompare(a.date));
  if (!recent.length) { c.innerHTML = '<div style="padding:12px;color:var(--text-muted);font-size:0.92rem">No workouts in the last 7 days.</div>'; return; }
  c.style.maxHeight = '300px'; c.style.overflowY = 'auto';
  const badges = { weights:'badge-weights', cardio:'badge-cardio', stretch:'badge-stretch', rest:'badge-rest' };
  const labels = { weights:'üèãÔ∏è Weights', cardio:'üö¥ Cardio', stretch:'üßò Stretch', rest:'üõã Rest' };
  c.innerHTML = recent.map((w, i) => {
    const ex = []; if (w.duration) ex.push(w.duration+'min'); if (w.hr) ex.push('‚ù§Ô∏è'+w.hr); if (w.focus) ex.push(w.focus==='fatburn'?'üî• fat burn':'üíì intensity');
    if (w.calsBurned) ex.push('üî•'+w.calsBurned+' cal');
    return '<div class="log-entry"><span class="log-date">'+formatDate(w.date)+'</span><div class="log-detail"><span class="log-badge '+badges[w.type]+'">'+labels[w.type]+'</span><span style="font-size:0.9rem;color:var(--text-secondary)">'+(ex.length?' ¬∑ '+ex.join(' ¬∑ '):'')+'</span>'+(w.note?'<div style="font-size:0.88rem;color:var(--text-muted);margin-top:2px">'+w.note+'</div>':'')+'</div>'+(w.type!=='rest'?'<span class="log-rpe" style="color:var(--accent-purple)">RPE '+w.rpe+'</span>':'')+'<button class="delete-btn" onclick="deleteWorkout('+i+')" title="Delete">√ó</button></div>';
  }).join('');
}

function deleteWorkout(di) {
  const sorted = [...data.workouts].sort((a, b) => b.date.localeCompare(a.date));
  const t = sorted[di]; const idx = data.workouts.findIndex(w => w.date===t.date && w.type===t.type && w.rpe===t.rpe && w.note===t.note);
  if (idx > -1) { data.workouts.splice(idx, 1); saveData(); renderWorkoutHistory(); refreshDashboard(); showToast('üóë Deleted'); }
}

// ===== MY WORKOUTS RECALL =====
function saveToMyWorkouts() {
  // Save the most recent workout as a template
  const recent = [...data.workouts].sort((a, b) => b.date.localeCompare(a.date))[0];
  if (!recent) { showToast('‚ö†Ô∏è Log a workout first'); return; }
  const name = recent.note || (recent.type + (recent.duration ? ' ' + recent.duration + 'min' : ''));
  if (!name || name === recent.type) { showToast('‚ö†Ô∏è Add a note to name this workout'); return; }
  // Check for duplicates
  if (data.myWorkouts.find(w => w.name.toLowerCase() === name.toLowerCase())) {
    showToast('‚ö†Ô∏è Already saved'); return;
  }
  data.myWorkouts.push({
    id: generateId(), name, type: recent.type, rpe: recent.rpe,
    duration: recent.duration, focus: recent.focus, hr: recent.hr,
    calsBurned: recent.calsBurned, count: 0
  });
  saveData(); renderMyWorkouts(); showToast('‚≠ê Saved to My Workouts!');
}

function renderMyWorkouts() {
  const c = document.getElementById('myWorkoutsList');
  if (!c) return;
  if (!data.myWorkouts || !data.myWorkouts.length) {
    c.innerHTML = '<div style="padding:12px;color:var(--text-muted);font-size:0.92rem">No saved workouts yet. Log a workout with a note, then tap "Save to My Workouts".</div>';
    return;
  }
  const icons = {weights:'üèãÔ∏è', cardio:'üö¥', stretch:'üßò', rest:'üõã'};
  const typeLabels = {cardio:'üö¥ Cardio', weights:'üèãÔ∏è Weights', stretch:'üßò Stretch', rest:'üõã Rest'};
  const typeOrder = ['cardio','weights','stretch','rest'];
  let html = '';
  for (const type of typeOrder) {
    const group = data.myWorkouts.filter(w => w.type === type).sort((a,b) => a.name.localeCompare(b.name));
    if (!group.length) continue;
    html += '<div style="font-size:0.85rem;font-weight:700;color:var(--accent-teal);text-transform:uppercase;letter-spacing:1px;padding:8px 0 4px;margin-top:4px">' + typeLabels[type] + '</div>';
    html += group.map(w => renderMyWorkoutItem(w, icons)).join('');
  }
  c.innerHTML = html;
}
function renderMyWorkoutItem(w, icons) {
  // Original render logic per item
  const sorted = [w]; // wrap for compatibility
  c.innerHTML = sorted.map(w => {
    const details = [];
    if (w.duration) details.push(w.duration + 'min');
    if (w.rpe) details.push('RPE ' + w.rpe);
    if (w.calsBurned) details.push('~' + w.calsBurned + ' cal');
    if (w.focus) details.push(w.focus === 'fatburn' ? 'üî• fat burn' : 'üíì intensity');
    var wid = w.id;
    return '<div class="my-food-item" style="cursor:default">' +
      '<div class="my-food-info" style="flex:1">' +
        '<div class="my-food-name">' + (icons[w.type]||'') + ' ' + w.name + '</div>' +
        '<div class="my-food-cal">' + details.join(' ¬∑ ') + (w.count ? ' ¬∑ used ' + w.count + '√ó' : '') + '</div>' +
      '</div>' +
      '<div style="display:flex;gap:6px;align-items:center">' +
        '<button class="btn-primary" onclick="quickLogMyWorkout(\x27' + wid + '\x27)" style="font-size:0.82rem;padding:7px 12px;margin:0;white-space:nowrap">‚ö° Log</button>' +
        '<button class="btn-secondary" onclick="prefillMyWorkout(\x27' + wid + '\x27)" style="font-size:0.82rem;padding:7px 12px;margin:0;white-space:nowrap">‚úèÔ∏è Edit</button>' +
        '<button class="my-food-remove" onclick="removeMyWorkout(\x27' + wid + '\x27)" title="Remove">√ó</button>' +
      '</div></div>';
  }).join('');
}

function quickLogMyWorkout(id) {
  const template = data.myWorkouts.find(w => w.id === id);
  if (!template) return;
  const w = getCurrentWeight();
  const calsBurned = template.calsBurned || estimateBurn(template.type, template.duration, template.rpe, w);
  data.workouts.push({
    date: today(), type: template.type, rpe: template.rpe,
    duration: template.duration, focus: template.focus || '', hr: template.hr || 0,
    note: template.name, calsBurned
  });
  template.count = (template.count || 0) + 1;
  saveData(); renderWorkoutHistory(); renderMyWorkouts(); refreshDashboard();
  showToast('üí™ ' + template.name + ' logged! ' + calsBurned + ' cal');
}

function prefillMyWorkout(id) {
  const template = data.myWorkouts.find(w => w.id === id);
  if (!template) return;
  // Set workout type
  currentWorkoutType = template.type;
  document.querySelectorAll('#workoutTypeSelect .quick-btn').forEach(b => b.classList.remove('active'));
  const typeLabels = {weights:'üèãÔ∏è Weights', cardio:'üö¥ Cardio', stretch:'üßò Stretch', rest:'üõã Rest Day'};
  document.querySelectorAll('#workoutTypeSelect .quick-btn').forEach(b => {
    if (b.textContent.trim() === typeLabels[template.type]) b.classList.add('active');
  });
  // Show/hide fields
  document.getElementById('durationSection').style.display = (template.type === 'cardio' || template.type === 'stretch') ? 'block' : 'none';
  document.getElementById('cardioFocusSection').style.display = template.type === 'cardio' ? 'block' : 'none';
  document.getElementById('rpeSection').style.display = template.type === 'rest' ? 'none' : 'block';
  document.getElementById('hrSection').style.display = template.type === 'rest' ? 'none' : 'block';
  document.getElementById('burnSection').style.display = template.type === 'rest' ? 'none' : 'block';
  // Fill values
  if (template.rpe) { document.getElementById('rpeSlider').value = template.rpe; updateSlider('rpe'); }
  if (template.duration) document.getElementById('workoutDuration').value = template.duration;
  if (template.hr) document.getElementById('workoutHR').value = template.hr;
  document.getElementById('workoutNote').value = template.name;
  if (template.calsBurned) document.getElementById('workoutCalsBurned').value = template.calsBurned;
  if (template.focus) {
    currentCardioFocus = template.focus;
    document.getElementById('btnFatBurn').classList.toggle('active', template.focus === 'fatburn');
    document.getElementById('btnIntensity').classList.toggle('active', template.focus === 'intensity');
  }
  updateBurnEstimate();
  // Scroll to the form
  document.getElementById('workoutTypeSelect').scrollIntoView({behavior: 'smooth', block: 'start'});
  showToast('‚úèÔ∏è Edit & log when ready');
}

function removeMyWorkout(id) {
  if (confirm('Remove from My Workouts?')) {
    data.myWorkouts = data.myWorkouts.filter(w => w.id !== id);
    saveData(); renderMyWorkouts(); showToast('üóë Removed');
  }
}


// ===== FOOD HEALTH CATEGORIES =====
function getFoodHealth(food) {
  const name = (food.name || '').toLowerCase();
  const cal = food.calories || 0;
  const protein = food.protein || 0;
  const fat = food.fat || 0;
  const carbs = food.carbs || 0;

  // GREEN: high protein/low cal, vegetables, fruits, lean proteins, whole grains
  const greenKeys = ['chicken','turkey','salmon','tuna','shrimp','egg white','oats','steel cut',
    'salad','spinach','broccoli','carrot','celery','vegetable','veggie','green bean','orange',
    'apple','berries','banana','olive','greek yogurt','cottage cheese','tofu','quinoa',
    'almond milk','sweet potato','lentil','bean','fish','cilantro'];
  
  // RED: high sugar, high fat treats, desserts, fried
  const redKeys = ['pie','cake','babka','cookie','ice cream','candy','chocolate','brownie',
    'donut','doughnut','pastry','fries','fried','soda','coke','pepsi','scotch','whisky',
    'whiskey','vodka','rum','gin','beer','wine','cocktail','cream cheese','bacon'];

  for (const k of greenKeys) { if (name.includes(k)) return 'green'; }
  for (const k of redKeys) { if (name.includes(k)) return 'red'; }
  
  // Calorie density check: high cal + high fat ratio = yellow/red
  if (cal > 300 && fat > 15) return 'red';
  if (cal > 200 && fat > 12) return 'yellow';
  
  // Protein-rich = green
  if (protein > 15 && cal < 300) return 'green';
  
  return 'yellow'; // default moderate
}

function healthIcon(category) {
  return category === 'green' ? 'üü¢' : category === 'red' ? 'üî¥' : 'üü°';
}

function healthLabel(category) {
  return category === 'green' ? 'Healthy' : category === 'red' ? 'Limit' : 'Moderate';
}


// ===== WALKING CALCULATOR =====
function calcWalkingCals(steps, rpe) {
  const w = getCurrentWeight();
  // Base: ~0.04 cal per step per pound
  // RPE multiplier: RPE 1=0.8x (stroll), RPE 2=1.0x (normal), RPE 3=1.2x (brisk), RPE 4=1.4x (power walk), RPE 5=1.6x (race walk/hills)
  const rpeMultiplier = 0.6 + ((rpe || 2) * 0.2);
  return Math.round(steps * w * 0.00035 * rpeMultiplier * CONFIG.expendAdjust);
}

function updateWalkingEstimate() {
  const steps = parseInt(document.getElementById('walkingSteps').value) || 0;
  const est = document.getElementById('walkingEstimate');
  if (steps > 0) {
    const rpe = parseInt(document.getElementById('walkingRPE').value) || 2;
    const cals = calcWalkingCals(steps, rpe);
    est.textContent = '~' + cals + ' cal burned';
    est.style.color = 'var(--accent-green)';
  } else { est.textContent = ''; }
}

function logWalking() {
  const steps = parseInt(document.getElementById('walkingSteps').value);
  if (!steps || steps < 100) { showToast('‚ö†Ô∏è Enter your steps'); return; }
  const rpe = parseInt(document.getElementById('walkingRPE').value) || 2;
  const cals = calcWalkingCals(steps, rpe);
  data.workouts.push({
    date: today(), type: 'cardio', rpe,
    duration: Math.round(steps / 100),
    focus: 'fatburn', hr: 0,
    note: 'Walking ' + steps.toLocaleString() + ' steps',
    calsBurned: cals
  });
  saveData();
  document.getElementById('walkingSteps').value = '';
  document.getElementById('walkingEstimate').textContent = '';
  showToast('üö∂ ' + steps.toLocaleString() + ' steps logged! ' + cals + ' cal');
  renderWorkoutHistory(); renderMyWorkouts(); refreshDashboard();
}


// ===== GOAL EDITOR =====
function renderGoalEditor() {
  const c = document.getElementById('goalEditor');
  if (!c) return;
  const g = getGoal();
  const p = data.profile || { height: 68, age: 50 };
  const current = getCurrentWeight();
  const modeLabels = { loss: 'üî• Weight Loss', maintain: '‚öñÔ∏è Maintenance', gain: 'üí™ Weight Gain' };
  const modeColors = { loss: 'var(--accent-orange)', maintain: 'var(--accent-green)', gain: 'var(--accent-blue)' };
  const deficitLabels = { loss: '750 cal/day deficit ‚Üí ~1.5 lbs/week', maintain: '200 cal/day deficit ‚Üí steady weight', gain: '300 cal/day surplus ‚Üí gradual gain' };

  c.innerHTML =
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">' +
      '<span class="card-title" style="margin:0">üéØ Your Goal</span>' +
      '<span style="font-size:0.88rem;font-weight:700;color:' + modeColors[g.mode] + '">' + modeLabels[g.mode] + '</span>' +
    '</div>' +
    '<div style="font-size:0.85rem;color:var(--text-muted);margin-bottom:12px">' + deficitLabels[g.mode] + '</div>' +
    '<div class="stat-grid" style="margin-bottom:12px">' +
      '<div class="stat-card"><div class="stat-value stat-green">' + current.toFixed(1) + '</div><div class="stat-label">Current lbs</div></div>' +
      '<div class="stat-card"><div class="stat-value stat-orange">' + g.goalWeight + '</div><div class="stat-label">Goal lbs</div></div>' +
    '</div>' +
    '<div style="display:flex;gap:8px;margin-bottom:10px">' +
      '<div style="flex:1"><label class="form-label">Height</label>' +
        '<div style="display:flex;gap:4px">' +
          '<input type="number" class="form-input" id="profileFeet" value="' + Math.floor(p.height / 12) + '" min="4" max="7" style="width:50%;text-align:center">' +
          '<span style="align-self:center;color:var(--text-muted);font-size:0.9rem">ft</span>' +
          '<input type="number" class="form-input" id="profileInches" value="' + (p.height % 12) + '" min="0" max="11" style="width:50%;text-align:center">' +
          '<span style="align-self:center;color:var(--text-muted);font-size:0.9rem">in</span>' +
        '</div></div>' +
      '<div style="flex:0.5"><label class="form-label">Age</label>' +
        '<input type="number" class="form-input" id="profileAge" value="' + p.age + '" min="16" max="100" style="text-align:center"></div>' +
    '</div>' +
    '<div style="display:flex;gap:8px;margin-bottom:10px">' +
      '<div style="flex:1"><label class="form-label">Goal Weight (lbs)</label>' +
        '<input type="number" step="0.5" class="form-input" id="goalWeightInput" value="' + g.goalWeight + '"></div>' +
      '<div style="flex:1"><label class="form-label">Target Date</label>' +
        '<select class="form-input" id="goalTimeframe" onchange="goalTimeframeChanged()" style="padding:10px">' +
          '<option value="4">4 weeks</option>' +
          '<option value="8">8 weeks</option>' +
          '<option value="12">12 weeks</option>' +
          '<option value="26">6 months</option>' +
          '<option value="eoy">End of year</option>' +
          '<option value="custom">Custom date</option>' +
        '</select></div>' +
    '</div>' +
    '<div id="customDateWrap" style="display:none;margin-bottom:10px">' +
      '<label class="form-label">Pick a date</label>' +
      '<input type="date" class="form-input" id="goalCustomDate">' +
    '</div>' +
    '<button class="btn-primary" onclick="saveGoal()" style="width:auto;padding:10px 24px;font-size:0.85rem">Update Goal</button>';

  // Set current timeframe selection
  const sel = document.getElementById('goalTimeframe');
  if (sel) {
    const weeks = g.goalWeeks;
    if ([4,8,12,26].includes(weeks)) sel.value = String(weeks);
    else sel.value = 'custom';
  }
}

function goalTimeframeChanged() {
  const v = document.getElementById('goalTimeframe').value;
  document.getElementById('customDateWrap').style.display = v === 'custom' || v === 'eoy' ? 'none' : 'none';
  if (v === 'custom') document.getElementById('customDateWrap').style.display = 'block';
}

function saveGoal() {
  const goalW = parseFloat(document.getElementById('goalWeightInput').value);
  if (!goalW || goalW < 90 || goalW > 400) { showToast('‚ö†Ô∏è Enter a valid goal weight'); return; }
  
  const timeVal = document.getElementById('goalTimeframe').value;
  let weeks;
  if (timeVal === 'eoy') {
    const now = new Date();
    const eoy = new Date(now.getFullYear(), 11, 31);
    weeks = Math.max(1, Math.round((eoy - now) / (7 * 24 * 60 * 60 * 1000)));
  } else if (timeVal === 'custom') {
    const customDate = document.getElementById('goalCustomDate').value;
    if (!customDate) { showToast('‚ö†Ô∏è Pick a target date'); return; }
    const diff = new Date(customDate) - new Date();
    weeks = Math.max(1, Math.round(diff / (7 * 24 * 60 * 60 * 1000)));
  } else {
    weeks = parseInt(timeVal);
  }
  
  const current = getCurrentWeight();
  
  // Save previous goal to history
  if (data.goal && data.goalHistory) {
    data.goalHistory.push({ ...data.goal, endedAt: today(), endWeight: current });
  }
  if (!data.goalHistory) data.goalHistory = [];
  
  // Save profile
  const feet = parseInt(document.getElementById('profileFeet').value) || 5;
  const inches = parseInt(document.getElementById('profileInches').value) || 8;
  const age = parseInt(document.getElementById('profileAge').value) || 50;
  data.profile = { height: feet * 12 + inches, age };

  data.goal = {
    startWeight: current,
    goalWeight: goalW,
    goalWeeks: weeks,
    startDate: today(),
    mode: current - goalW > 5 ? 'loss' : current - goalW > 0 ? 'maintain' : 'gain'
  };
  data.startDate = today();
  
  saveData();
  renderGoalEditor();
  updateMetabolicDisplay();
  renderWeightChart();
  refreshDashboard();
  
  const mode = data.goal.mode;
  const modeLabel = mode === 'loss' ? 'Weight Loss' : mode === 'maintain' ? 'Maintenance' : 'Weight Gain';
  showToast('üéØ Goal set: ' + goalW + ' lbs in ' + weeks + ' weeks (' + modeLabel + ')');
}

// ===== WEIGHT =====
function saveWeight() {
  const w = parseFloat(document.getElementById('weightInput').value);
  if (!w || w < 100 || w > 400) { showToast('‚ö†Ô∏è Enter a valid weight'); return; }
  data.weights = data.weights.filter(e => e.date !== today());
  data.weights.push({ date: today(), weight: w }); saveData();
  document.getElementById('weightInput').value = '';
  showToast('‚öñÔ∏è Weight: ' + w + ' lbs');
  updateMetabolicDisplay(); renderWeightHistory(); renderWeightStats(); renderWeightChart(); refreshDashboard(); checkGoalReached();
}

function renderWeightHistory() {
  const c = document.getElementById('weightHistory');
  const recent = [...data.weights].sort((a, b) => b.date.localeCompare(a.date)).slice(0, 20);
  if (!recent.length) { c.innerHTML = '<div style="padding:12px;color:var(--text-muted);font-size:0.85rem">No weight entries yet.</div>'; return; }
  c.innerHTML = recent.map((e, i) => {
    const diff = i < recent.length - 1 ? (e.weight - recent[i+1].weight) : 0;
    const ds = diff === 0 ? '' : (diff > 0 ? '<span style="color:var(--accent-red)">+'+diff.toFixed(1)+'</span>' : '<span style="color:var(--accent-green)">'+diff.toFixed(1)+'</span>');
    return '<div class="log-entry"><span class="log-date">'+formatDate(e.date)+'</span><span style="font-family:JetBrains Mono;font-weight:700;font-size:0.95rem">'+e.weight.toFixed(1)+' lbs</span>'+ds+'<button class="delete-btn" onclick="deleteWeight(\''+e.date+'\')" title="Delete">√ó</button></div>';
  }).join('');
}

function deleteWeight(date) { data.weights = data.weights.filter(w => w.date !== date); saveData(); renderWeightHistory(); renderWeightStats(); renderWeightChart(); refreshDashboard(); showToast('üóë Deleted'); }

function renderWeightStats() {
  const sorted = [...data.weights].sort((a, b) => a.date.localeCompare(b.date));
  if (sorted.length < 2) { document.getElementById('avg7day').textContent = '‚Äî'; document.getElementById('weeklyChange').textContent = '‚Äî'; return; }
  const last7 = sorted.slice(-7); const avg = last7.reduce((s, e) => s + e.weight, 0) / last7.length;
  document.getElementById('avg7day').textContent = avg.toFixed(1);
  if (sorted.length >= 14) {
    const prev7 = sorted.slice(-14, -7); const prevAvg = prev7.reduce((s, e) => s + e.weight, 0) / prev7.length;
    const ch = avg - prevAvg; const el = document.getElementById('weeklyChange');
    el.textContent = (ch > 0 ? '+' : '') + ch.toFixed(1); el.className = 'stat-value ' + (ch <= 0 ? 'stat-green' : 'stat-red');
  }
}

// ===== WEIGHT CHART =====
let weightChart = null;

// Custom tooltip positioner: fixed top-right of chart
if (typeof Chart !== 'undefined') {
  Chart.Tooltip.positioners.topRight = function(elements, eventPosition) {
    const chart = this.chart;
    return { x: chart.chartArea.right - 10, y: chart.chartArea.top + 5 };
  };
}

function renderWeightChart() {
  const ctx = document.getElementById('weightChart').getContext('2d');
  if (weightChart) weightChart.destroy();
  const sorted = [...data.weights].sort((a, b) => a.date.localeCompare(b.date));
  // Update current day summary above chart
  const summaryEl = document.getElementById('weightChartSummary');
  if (summaryEl && sorted.length) {
    const latest = sorted[sorted.length - 1];
    const daysIn = daysBetween(data.startDate, today());
    const goalPerDay = (CONFIG.startWeight - CONFIG.goalWeight) / (CONFIG.goalWeeks * 7);
    const expectedWeight = Math.round((CONFIG.startWeight - (goalPerDay * daysIn)) * 10) / 10;
    const avg7 = sorted.length >= 2 ? sorted.slice(-7).reduce((s,w) => s + w.weight, 0) / Math.min(sorted.length, 7) : latest.weight;
    summaryEl.innerHTML =
      '<div style="display:flex;justify-content:space-around;text-align:center">' +
      '<div><div style="font-family:JetBrains Mono;font-size:1.2rem;font-weight:700;color:var(--accent-green)">' + latest.weight + '</div><div style="font-size:0.82rem;color:var(--text-muted)">Today</div></div>' +
      '<div><div style="font-family:JetBrains Mono;font-size:1.2rem;font-weight:700;color:var(--accent-blue)">' + avg7.toFixed(1) + '</div><div style="font-size:0.82rem;color:var(--text-muted)">7-Day Avg</div></div>' +
      '<div><div style="font-family:JetBrains Mono;font-size:1.2rem;font-weight:700;color:var(--accent-orange)">' + expectedWeight + '</div><div style="font-size:0.82rem;color:var(--text-muted)">Goal Today</div></div>' +
      '</div>';
  }
  const isLight = document.documentElement.hasAttribute('data-theme');
  const gridColor = isLight ? 'rgba(0,0,0,0.08)' : 'rgba(255,255,255,0.08)';
  const textColor = isLight ? '#57606a' : '#8b949e';
  const goalPoints = [];
  for (let i = 0; i <= CONFIG.goalWeeks * 7; i += 7) {
    const d = new Date(data.startDate); d.setDate(d.getDate() + i);
    goalPoints.push({ x: d.toISOString().split('T')[0], y: Math.round((CONFIG.startWeight - ((CONFIG.startWeight - CONFIG.goalWeight) / (CONFIG.goalWeeks * 7)) * i) * 10) / 10 });
  }
  const avgData = sorted.map((e, i) => {
    const win = sorted.slice(Math.max(0, i - 6), i + 1);
    return { x: e.date, y: Math.round((win.reduce((s, w) => s + w.weight, 0) / win.length) * 10) / 10 };
  });
  const labels = [...new Set([...sorted.map(e => e.date), ...goalPoints.map(p => p.x)])].sort();
  weightChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [
      { label: 'Weight', data: sorted.map(e => ({x:e.date,y:e.weight})), borderColor:'#2ea043', borderWidth:2, pointRadius:3, pointBackgroundColor:'#2ea043', tension:0.3, fill:false },
      { label: '7-Day Avg', data: avgData, borderColor:'#58a6ff', borderWidth:2, borderDash:[5,5], pointRadius:0, tension:0.4, fill:false },
      { label: 'Goal', data: goalPoints.map(p=>({x:p.x,y:p.y})), borderColor:'#d29922', borderWidth:1.5, borderDash:[8,4], pointRadius:0, tension:0, fill:false }
    ]},
    options: { responsive:true, maintainAspectRatio:false, interaction:{intersect:false,mode:'index'},
      plugins:{legend:{labels:{color:textColor,font:{size:11,family:'DM Sans'},boxWidth:12}},
        tooltip:{enabled:false},
      },
      scales:{ x:{type:'category',ticks:{color:textColor,font:{size:10},maxTicksLimit:8},grid:{color:gridColor}},
        y:{min:CONFIG.goalWeight-3,max:CONFIG.startWeight+3,ticks:{color:textColor,font:{size:10}},grid:{color:gridColor}} }
    }
  });
}

// ===== AI NUTRITION =====
let lastAiResult = null;

async function estimateCalories() {
  const input = document.getElementById('foodInput').value.trim();
  if (!input) { showToast('‚ö†Ô∏è Describe what you ate'); return; }
  const btn = document.getElementById('estimateBtn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Estimating...';
  try {
    const response = await callAI(input);
    lastAiResult = response; displayAiResult(response);
  } catch (err) {
    console.error(err); lastAiResult = estimateLocally(input); displayAiResult(lastAiResult);
  } finally { btn.disabled = false; btn.textContent = 'üîç Estimate'; }
}

async function callAI(food) {
  if (CONFIG.workerUrl) {
    try {
      const r = await fetch(CONFIG.workerUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({food}) });
      if (r.ok) {
        const d = await r.json();
        if (d.items) return d;
        console.warn('Worker returned unexpected format:', d);
      } else {
        const errText = await r.text();
        console.warn('Worker error ' + r.status + ':', errText);
      }
    } catch(e) { console.warn('Worker fetch failed:', e.message); }
  }
  // Fallback to local estimation (direct API calls blocked by CORS)
  console.log('Using local estimation fallback');
  return estimateLocally(food);
}

function estimateLocally(desc) {
  const lower = desc.toLowerCase().replace(/[^a-z0-9\s]/g, '');
  const items = []; let tC=0,tP=0,tCa=0,tF=0;
  const foods = [
    // Breakfast cereals
    {keys:['cheerios','cherios','cherrios','cherries cereal','multigrain cheerios'],name:'Multigrain Cheerios (1 cup)',cal:110,p:3,c:24,f:1.5},
    {keys:['oatmeal','oats','porridge'],name:'Oatmeal (1 cup cooked)',cal:160,p:6,c:27,f:3.5},
    {keys:['granola'],name:'Granola (1/2 cup)',cal:210,p:5,c:30,f:8},
    // Milk & dairy
    {keys:['almond milk','almond milk 30'],name:'Almond milk (1 cup)',cal:30,p:1,c:1,f:2.5},
    {keys:['skim milk','fat free milk'],name:'Skim milk (1 cup)',cal:85,p:8,c:12,f:0.2},
    {keys:['whole milk','milk'],name:'Whole milk (1 cup)',cal:150,p:8,c:12,f:8},
    {keys:['yogurt','greek yogurt'],name:'Greek yogurt (1 cup)',cal:130,p:17,c:9,f:4},
    {keys:['cottage cheese'],name:'Cottage cheese (1 cup)',cal:220,p:25,c:8,f:10},
    {keys:['cheese','cheddar'],name:'Cheese (1 oz)',cal:110,p:7,c:0.5,f:9},
    {keys:['cream cheese'],name:'Cream cheese (2 tbsp)',cal:100,p:2,c:1,f:10},
    // Eggs
    {keys:['eggs','2 eggs','two eggs','scrambled eggs'],name:'Eggs (2 large)',cal:144,p:12,c:1,f:10},
    {keys:['egg','1 egg','one egg','fried egg','boiled egg'],name:'Egg (large)',cal:72,p:6,c:0.5,f:5},
    {keys:['egg whites','egg white'],name:'Egg whites (3)',cal:51,p:11,c:0.5,f:0.2},
    // Bread & bakery
    {keys:['toast','bread','slice of bread','whole wheat bread'],name:'Toast/Bread (1 slice)',cal:80,p:3,c:14,f:1},
    {keys:['bagel'],name:'Bagel (medium)',cal:270,p:10,c:53,f:1.5},
    {keys:['muffin','english muffin'],name:'English muffin',cal:130,p:5,c:25,f:1},
    {keys:['croissant'],name:'Croissant',cal:230,p:5,c:26,f:12},
    {keys:['pancake','pancakes'],name:'Pancakes (2)',cal:350,p:8,c:50,f:14},
    {keys:['waffle','waffles'],name:'Waffles (2)',cal:380,p:8,c:50,f:16},
    // Fruits
    {keys:['banana'],name:'Banana (medium)',cal:105,p:1.3,c:27,f:0.4},
    {keys:['apple'],name:'Apple (medium)',cal:95,p:0.5,c:25,f:0.3},
    {keys:['orange'],name:'Orange (medium)',cal:65,p:1,c:16,f:0.2},
    {keys:['berries','blueberries','strawberries'],name:'Berries (1 cup)',cal:85,p:1,c:21,f:0.5},
    {keys:['grapes'],name:'Grapes (1 cup)',cal:100,p:1,c:27,f:0.3},
    // Protein
    {keys:['chicken breast','grilled chicken'],name:'Chicken breast (6oz)',cal:280,p:53,c:0,f:6},
    {keys:['chicken','chicken thigh'],name:'Chicken (6oz)',cal:320,p:42,c:0,f:16},
    {keys:['salmon','grilled salmon','baked salmon'],name:'Salmon fillet (6oz)',cal:350,p:40,c:0,f:20},
    {keys:['steak','beef','sirloin','ribeye'],name:'Steak (6oz)',cal:380,p:46,c:0,f:20},
    {keys:['tuna','tuna can'],name:'Tuna (1 can)',cal:200,p:40,c:0,f:2},
    {keys:['turkey','turkey breast'],name:'Turkey breast (6oz)',cal:250,p:50,c:0,f:4},
    {keys:['shrimp','prawns'],name:'Shrimp (6oz)',cal:170,p:36,c:0,f:2},
    {keys:['tofu'],name:'Tofu (1 cup)',cal:190,p:20,c:5,f:11},
    {keys:['protein shake','protein smoothie','whey'],name:'Protein shake',cal:160,p:30,c:5,f:2},
    {keys:['protein bar'],name:'Protein bar',cal:220,p:20,c:25,f:8},
    // Grains & carbs
    {keys:['rice','white rice','brown rice'],name:'Rice (1 cup cooked)',cal:210,p:4,c:45,f:0.5},
    {keys:['pasta','spaghetti','noodles','penne'],name:'Pasta (1 cup cooked)',cal:220,p:8,c:43,f:1.3},
    {keys:['potato','baked potato','mashed potato'],name:'Potato (medium)',cal:160,p:4,c:37,f:0.2},
    {keys:['sweet potato'],name:'Sweet potato (medium)',cal:115,p:2,c:27,f:0.1},
    {keys:['quinoa'],name:'Quinoa (1 cup cooked)',cal:220,p:8,c:39,f:3.5},
    // Vegetables
    {keys:['salad','mixed salad','garden salad'],name:'Salad with dressing',cal:180,p:4,c:12,f:14},
    {keys:['broccoli'],name:'Broccoli (1 cup)',cal:55,p:3.7,c:11,f:0.6},
    {keys:['spinach'],name:'Spinach (1 cup)',cal:7,p:0.9,c:1,f:0.1},
    {keys:['green beans','string beans'],name:'Green beans (1 cup)',cal:35,p:2,c:7,f:0.2},
    {keys:['carrots','carrot'],name:'Carrots (1 cup)',cal:50,p:1,c:12,f:0.3},
    // Snacks
    {keys:['almonds'],name:'Almonds (1/4 cup)',cal:210,p:8,c:7,f:18},
    {keys:['nuts','mixed nuts','walnuts','cashews'],name:'Mixed nuts (1/4 cup)',cal:200,p:6,c:8,f:17},
    {keys:['peanut butter','pb'],name:'Peanut butter (2 tbsp)',cal:190,p:8,c:7,f:16},
    {keys:['hummus'],name:'Hummus (1/4 cup)',cal:100,p:5,c:9,f:6},
    {keys:['chips','potato chips'],name:'Chips (small bag)',cal:150,p:2,c:15,f:10},
    {keys:['crackers'],name:'Crackers (6 pcs)',cal:120,p:2,c:19,f:4},
    {keys:['granola bar','energy bar'],name:'Granola bar',cal:190,p:3,c:29,f:7},
    {keys:['dark chocolate','chocolate'],name:'Dark chocolate (1 oz)',cal:170,p:2,c:13,f:12},
    {keys:['popcorn'],name:'Popcorn (3 cups)',cal:95,p:3,c:19,f:1},
    // Meals
    {keys:['sandwich','turkey sandwich','ham sandwich'],name:'Sandwich',cal:400,p:22,c:40,f:18},
    {keys:['burger','hamburger','cheeseburger'],name:'Hamburger',cal:550,p:30,c:40,f:30},
    {keys:['pizza'],name:'Pizza (2 slices)',cal:560,p:22,c:62,f:24},
    {keys:['soup','chicken soup','vegetable soup'],name:'Soup (1 bowl)',cal:180,p:10,c:20,f:6},
    {keys:['wrap','burrito','tortilla'],name:'Wrap/burrito',cal:450,p:25,c:45,f:18},
    {keys:['sushi','sushi roll'],name:'Sushi roll (6 pcs)',cal:300,p:12,c:42,f:8},
    {keys:['stir fry','stirfry'],name:'Stir fry with rice',cal:450,p:25,c:50,f:16},
    // Drinks
    {keys:['coffee','black coffee'],name:'Coffee with milk',cal:30,p:1,c:2,f:1.5},
    {keys:['latte','cappuccino'],name:'Latte',cal:130,p:8,c:12,f:5},
    {keys:['juice','orange juice','apple juice'],name:'Juice (8oz)',cal:120,p:1,c:28,f:0},
    {keys:['smoothie','fruit smoothie'],name:'Smoothie',cal:250,p:5,c:45,f:5},
    {keys:['soda','coke','cola','pepsi'],name:'Soda (12oz)',cal:140,p:0,c:39,f:0},
    {keys:['beer'],name:'Beer (12oz)',cal:150,p:1,c:13,f:0},
    {keys:['wine','red wine','white wine'],name:'Wine (5oz)',cal:125,p:0,c:4,f:0},
    {keys:['water','sparkling water'],name:'Water',cal:0,p:0,c:0,f:0},
  ];

  // Fuzzy match: check each food's keys against the input
  const matched = new Set();
  for (const food of foods) {
    for (const key of food.keys) {
      // Check if all words of the key appear in the input (order-independent)
      const keyWords = key.split(' ');
      const allFound = keyWords.every(kw => lower.includes(kw));
      if (allFound && !matched.has(food.name)) {
        const adj = Math.round(food.cal * CONFIG.intakeAdjust);
        items.push({name:food.name,calories:adj,protein:food.p,carbs:food.c,fat:food.f});
        tC+=adj; tP+=food.p; tCa+=food.c; tF+=food.f;
        matched.add(food.name);
        break;
      }
    }
  }

  if (items.length === 0) {
    // Unknown food ‚Äî rough estimate
    const est = Math.round(250 * CONFIG.intakeAdjust);
    items.push({name:desc,calories:est,protein:10,carbs:25,fat:8}); tC=est; tP=10; tCa=25; tF=8;
  }

  return {items,total_calories:tC,total_protein:Math.round(tP),total_carbs:Math.round(tCa),total_fat:Math.round(tF),note:'Estimated locally. Deploy AI worker for more accurate results.'};
}

function displayAiResult(r) {
  const d = document.getElementById('aiResult');
  let h = '';
  r.items.forEach(i => {
    const health = getFoodHealth(i);
    const hi = healthIcon(health);
    const hlabel = health === 'green' ? 'Healthy' : health === 'red' ? 'Limit this' : '';
    h += '<div class="ai-result-item"><span class="food-name">' + hi + ' ' + i.name + (hlabel ? ' <span style="font-size:0.8rem;font-weight:400;color:' + (health==='green'?'var(--accent-green)':'var(--accent-red)') + '">' + hlabel + '</span>' : '') + '</span><span class="food-cal">' + i.calories + ' cal</span></div>';
  });
  h += '<div class="ai-result-total"><span>Total (+5% adjustment)</span><span class="total-cal">'+r.total_calories+' cal</span></div>';
  h += '<div class="ai-result-macro"><span>ü•© Protein: '+r.total_protein+'g</span><span>üçû Carbs: '+r.total_carbs+'g</span><span>üßà Fat: '+r.total_fat+'g</span></div>';
  if (r.note) h += '<div class="ai-result-note">'+r.note+'</div>';
  h += '<div class="ai-result-actions"><button class="btn-primary" onclick="logAiFood()" style="font-size:0.85rem;padding:10px">‚úÖ Log This</button><button class="btn-secondary" onclick="saveToMyFoods()" style="margin:0;font-size:0.85rem;padding:10px">‚≠ê Save Items</button>' + (r.items.length > 1 ? '<button class="btn-secondary" onclick="saveAsMeal()" style="margin:0;font-size:0.85rem;padding:10px">üç± Save as Meal</button>' : '') + '</div>';
  d.innerHTML = h; d.classList.add('visible');
  // Clear input for next entry
  document.getElementById('foodInput').value = '';
}

function logAiFood() {
  if (!lastAiResult) return;
  const entry = getTodayCalorieEntry();
  lastAiResult.items.forEach(i => {
    entry.log.push({id:generateId(),name:i.name,calories:i.calories,protein:i.protein||0,carbs:i.carbs||0,fat:i.fat||0,time:new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})});
  });
  entry.consumed = entry.log.reduce((s,f)=>s+f.calories,0);
  saveTodayCalorieEntry(entry);
  document.getElementById('foodInput').value = '';
  document.getElementById('aiResult').classList.remove('visible');
  renderFoodLog(); updateCalorieSummary(); showToast('üçΩ Food logged!');
}

function saveToMyFoods() {
  if (!lastAiResult) return;
  lastAiResult.items.forEach(i => {
    if (!data.myFoods.find(f => f.name.toLowerCase() === i.name.toLowerCase())) {
      data.myFoods.push({id:generateId(),name:i.name,calories:i.calories,protein:i.protein||0,carbs:i.carbs||0,fat:i.fat||0,count:0});
    }
  });
  saveData(); renderMyFoods(); showToast('‚≠ê Saved to My Foods!');
}


// ===== MY MEALS =====
function saveAsMeal() {
  if (!lastAiResult || !lastAiResult.items) {
    showToast('‚ö†Ô∏è Estimate a meal first'); return;
  }
  // Show inline naming UI instead of prompt()
  const container = document.getElementById('aiResult');
  // Auto-suggest name from first item or food input
  const inputText = document.getElementById('foodInput').value.trim();
  const suggestion = inputText || lastAiResult.items.map(i => i.name.split('(')[0].trim()).slice(0,2).join(' + ');
  
  let nameBox = document.getElementById('mealNameBox');
  if (nameBox) { nameBox.remove(); }
  
  const div = document.createElement('div');
  div.id = 'mealNameBox';
  div.style.cssText = 'margin-top:10px;padding:10px;border:1px solid var(--accent-blue);border-radius:8px;background:var(--bg-input)';
  div.innerHTML = '<div style="font-size:0.88rem;font-weight:600;color:var(--accent-blue);margin-bottom:6px">üç± Name this meal:</div>' +
    '<div style="display:flex;gap:6px;align-items:center">' +
    '<input type="text" id="mealNameInput" class="form-input" value="' + suggestion.replace(/"/g,'&quot;') + '" style="flex:1;font-size:0.95rem">' +
    '<button onclick="document.getElementById(\'mealNameInput\').value=\'\'" style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--text-muted)">‚úï</button>' +
    '</div>' +
    '<button class="btn-primary" onclick="confirmSaveMeal()" style="margin-top:8px;width:auto;padding:8px 20px;font-size:0.85rem">Save Meal</button>';
  container.appendChild(div);
  container.classList.add('visible');
  document.getElementById('mealNameInput').focus();
  document.getElementById('mealNameInput').select();
}

function confirmSaveMeal() {
  const nameEl = document.getElementById('mealNameInput');
  if (!nameEl) return;
  const name = nameEl.value.trim();
  if (!name) { showToast('‚ö†Ô∏è Enter a meal name'); return; }
  if (!lastAiResult || !lastAiResult.items) { showToast('‚ö†Ô∏è No meal data'); return; }
  
  if (data.myMeals.find(m => m.name.toLowerCase() === name.toLowerCase())) {
    showToast('‚ö†Ô∏è Meal name already exists'); return;
  }
  
  const meal = {
    id: generateId(), name: name,
    items: lastAiResult.items.map(i => ({name:i.name,calories:i.calories,protein:i.protein||0,carbs:i.carbs||0,fat:i.fat||0})),
    calories: lastAiResult.total_calories,
    protein: lastAiResult.total_protein || 0,
    carbs: lastAiResult.total_carbs || 0,
    fat: lastAiResult.total_fat || 0,
    count: 0
  };
  data.myMeals.push(meal);
  saveData(); renderMyFoods();
  
  const box = document.getElementById('mealNameBox');
  if (box) box.remove();
  lastAiResult = null;
  showToast('üç± Saved: ' + name);
}

// ===== MY FOODS RECALL =====
let selectedMyFoods = new Set();

function renderMyFoods() {
  const c = document.getElementById('myFoodsList'); selectedMyFoods.clear();
  const hasFoods = data.myFoods && data.myFoods.length;
  const hasMeals = data.myMeals && data.myMeals.length;
  if (!hasFoods && !hasMeals) {
    c.innerHTML = '<div style="padding:12px;color:var(--text-muted);font-size:0.92rem">No saved foods yet. Use AI estimator and tap "Save to My Foods" to build your list.</div>';
    document.getElementById('addSelectedBtn').style.display = 'none'; return;
  }
  let h = '';
  // Render My Meals first
  if (hasMeals) {
    h += '<div style="font-size:0.85rem;font-weight:700;color:var(--accent-blue);text-transform:uppercase;letter-spacing:1px;padding:8px 0 4px;margin-top:4px">üç± My Meals</div>';
    const sortedMeals = [...data.myMeals].sort((a,b) => a.name.localeCompare(b.name));
    h += sortedMeals.map(m => {
      const health = getFoodHealth(m);
      const itemNames = (m.items||[]).map(i => i.name).join(', ');
      return '<div class="my-food-item" id="mf-'+m.id+'" onclick="toggleMyFood(\''+m.id+'\')">' +
        '<div class="my-food-check" id="mfc-'+m.id+'">‚úì</div>' +
        '<div class="my-food-info"><div class="my-food-name">' + healthIcon(health) + ' ' + m.name + '</div>' +
        '<div class="my-food-cal">' + m.calories + ' cal ¬∑ P:' + (m.protein||0) + 'g C:' + (m.carbs||0) + 'g F:' + (m.fat||0) + 'g' + (m.count ? ' ¬∑ used ' + m.count + '√ó' : '') + '</div>' +
        (itemNames ? '<div style="font-size:0.82rem;color:var(--text-muted);font-style:italic">' + itemNames + '</div>' : '') +
        '</div>' +
        '<button class="my-food-remove" onclick="event.stopPropagation();removeMyFood(\''+m.id+'\')" title="Remove">√ó</button></div>';
    }).join('');
  }
  // Group foods by health category, alphabetical within each
  if (hasFoods) {
    const categories = [
      {key:'green', label:'üü¢ Healthy Choices', color:'var(--accent-green)'},
      {key:'yellow', label:'üü° Moderate', color:'var(--accent-orange)'},
      {key:'red', label:'üî¥ Consume Less', color:'var(--accent-red)'}
    ];
    for (const cat of categories) {
      const foods = data.myFoods.filter(f => getFoodHealth(f) === cat.key).sort((a,b) => a.name.localeCompare(b.name));
      if (!foods.length) continue;
      h += '<div style="font-size:0.85rem;font-weight:700;color:'+cat.color+';text-transform:uppercase;letter-spacing:1px;padding:8px 0 4px;margin-top:4px">' + cat.label + '</div>';
      h += foods.map(f =>
        '<div class="my-food-item" id="mf-'+f.id+'" onclick="toggleMyFood(\''+f.id+'\')">' +
        '<div class="my-food-check" id="mfc-'+f.id+'">‚úì</div>' +
        '<div class="my-food-info"><div class="my-food-name">' + healthIcon(cat.key) + ' ' + f.name + '</div>' +
        '<div class="my-food-cal">' + f.calories + ' cal ¬∑ P:' + (f.protein||0) + 'g C:' + (f.carbs||0) + 'g F:' + (f.fat||0) + 'g' + (f.count ? ' ¬∑ used ' + f.count + '√ó' : '') + '</div></div>' +
        '<button class="my-food-remove" onclick="event.stopPropagation();removeMyFood(\''+f.id+'\')" title="Remove">√ó</button></div>'
      ).join('');
    }
  }
  c.innerHTML = h;
  document.getElementById('addSelectedBtn').style.display = 'none';
}

function toggleMyFood(id) {
  if (selectedMyFoods.has(id)) { selectedMyFoods.delete(id); document.getElementById('mf-'+id).classList.remove('selected'); }
  else { selectedMyFoods.add(id); document.getElementById('mf-'+id).classList.add('selected'); }
  const btn = document.getElementById('addSelectedBtn');
  btn.style.display = selectedMyFoods.size > 0 ? 'block' : 'none';
  btn.textContent = '‚úÖ Add ' + selectedMyFoods.size + ' Selected to Today\'s Log';
}

function addSelectedMyFoods() {
  if (!selectedMyFoods.size) return;
  const entry = getTodayCalorieEntry(); let count = 0;
  const timeStr = new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
  selectedMyFoods.forEach(id => {
    // Check meals first
    const meal = data.myMeals && data.myMeals.find(m => m.id === id);
    if (meal) {
      // Log the meal as a single item with combined macros
      entry.log.push({id:generateId(),name:'üç± '+meal.name,calories:meal.calories,protein:meal.protein||0,carbs:meal.carbs||0,fat:meal.fat||0,time:timeStr});
      meal.count = (meal.count||0) + 1; count++;
      return;
    }
    const food = data.myFoods.find(f => f.id === id);
    if (food) {
      entry.log.push({id:generateId(),name:food.name,calories:food.calories,protein:food.protein,carbs:food.carbs,fat:food.fat,time:timeStr});
      food.count = (food.count||0) + 1; count++;
    }
  });
  entry.consumed = entry.log.reduce((s,f)=>s+f.calories,0);
  saveTodayCalorieEntry(entry); saveData();
  selectedMyFoods.clear(); renderMyFoods(); renderFoodLog(); updateCalorieSummary();
  showToast('üçΩ ' + count + ' item(s) added!');
}

function removeMyFood(id) {
  if (confirm('Remove from saved items?')) {
    data.myFoods = data.myFoods.filter(f => f.id !== id);
    if (data.myMeals) data.myMeals = data.myMeals.filter(m => m.id !== id);
    saveData(); renderMyFoods(); showToast('üóë Removed');
  }
}

// ===== TODAY'S FOOD LOG =====
function getTodayCalorieEntry() {
  let e = data.calories.find(c => c.date === today());
  if (!e) { const w = getCurrentWeight(); e = {date:today(),activity:currentActivity,target:calcTarget(w,currentActivity),consumed:0,adherence:'',log:[]}; data.calories.push(e); saveData(); }
  if (!e.log) e.log = []; return e;
}
function getTodayFoodLog() { const e = data.calories.find(c=>c.date===today()); return e&&e.log?e.log:[]; }
function saveTodayCalorieEntry(e) { const i = data.calories.findIndex(c=>c.date===today()); if(i>-1) data.calories[i]=e; else data.calories.push(e); saveData(); }

function renderFoodLog() {
  const c = document.getElementById('foodLogList'); const log = getTodayFoodLog();
  if (!log.length) { c.innerHTML = '<div style="padding:12px;color:var(--text-muted);font-size:0.85rem">No food logged today yet.</div>'; return; }
  c.innerHTML = log.map(f =>
    '<div class="food-log-item"><span class="food-log-name">'+f.name+' <span style="color:var(--text-muted);font-size:0.85rem">'+(f.time||'')+'</span></span><span class="food-log-cal">'+f.calories+'</span><button class="food-log-remove" onclick="removeFoodLogItem(\''+f.id+'\')" title="Remove">√ó</button></div>'
  ).join('');
}

function removeFoodLogItem(id) {
  const e = getTodayCalorieEntry(); e.log = e.log.filter(f=>f.id!==id);
  e.consumed = e.log.reduce((s,f)=>s+f.calories,0); saveTodayCalorieEntry(e);
  renderFoodLog(); updateCalorieSummary(); showToast('üóë Removed');
}

function updateCalorieSummary() {
  const e = getTodayCalorieEntry(); const consumed = e.log?e.log.reduce((s,f)=>s+f.calories,0):0;
  const w = getCurrentWeight(); const target = calcTarget(w, currentActivity);
  const pct = Math.min((consumed/target)*100, 120);
  const bar = document.getElementById('calorieBar');
  bar.style.width = Math.min(pct,100)+'%'; bar.classList.toggle('over', consumed > target);
  const burned = getTodayBurned();
  const effectiveBudget = target + burned;
  const rem = effectiveBudget - consumed;
  document.getElementById('calRemaining').textContent = rem > 0 ? rem.toLocaleString()+' cal remaining' + (burned ? ' (incl. '+burned+' burned)' : '') : Math.abs(rem).toLocaleString()+' cal over';
  document.getElementById('calConsumed').textContent = consumed.toLocaleString();
  const tP = e.log?e.log.reduce((s,f)=>s+(f.protein||0),0):0;
  const tCa = e.log?e.log.reduce((s,f)=>s+(f.carbs||0),0):0;
  document.getElementById('macroSummary').textContent = 'ü•© '+tP+'g protein ¬∑ üçû '+tCa+'g carbs ¬∑ üßà '+(e.log?e.log.reduce((s,f)=>s+(f.fat||0),0):0)+'g fat';
}

// ===== DASHBOARD =====
function refreshDashboard() {
  const w = getCurrentWeight(); const lost = CONFIG.startWeight - w; const toGo = w - CONFIG.goalWeight;
  const pct = Math.max(0, Math.min(100, (lost / (CONFIG.startWeight - CONFIG.goalWeight)) * 100));
  const progBar = document.getElementById('progressBar');
  if (progBar) progBar.style.width = Math.min(pct, 100) + '%';
  document.getElementById('lbsLost').textContent = Math.max(0, lost).toFixed(1);
  // Goal pace indicator
  const daysIn = daysBetween(data.startDate, today());
  const expectedLoss = ((CONFIG.startWeight - CONFIG.goalWeight) / (CONFIG.goalWeeks * 7)) * daysIn;
  const paceEl = document.getElementById('goalPace');
  if (paceEl) {
    if (daysIn < 3) { paceEl.textContent = 'Just started ‚Äî keep going!'; paceEl.style.color = 'var(--text-secondary)'; }
    else if (lost >= expectedLoss * 0.9) { paceEl.textContent = '‚úÖ On track ‚Äî ' + lost.toFixed(1) + ' lost vs ' + expectedLoss.toFixed(1) + ' expected'; paceEl.style.color = 'var(--accent-green)'; }
    else if (lost >= expectedLoss * 0.7) { paceEl.textContent = '‚ö†Ô∏è Slightly behind ‚Äî ' + lost.toFixed(1) + ' lost vs ' + expectedLoss.toFixed(1) + ' expected'; paceEl.style.color = 'var(--accent-orange)'; }
    else { paceEl.textContent = 'üî¥ Behind pace ‚Äî ' + lost.toFixed(1) + ' lost vs ' + expectedLoss.toFixed(1) + ' expected'; paceEl.style.color = 'var(--accent-red)'; }
  }
  const weeksIn = Math.floor(daysBetween(data.startDate, today()) / 7) + 1;
  document.getElementById('goalSubtitle').innerHTML = 'Week <strong>'+Math.min(weeksIn,CONFIG.goalWeeks)+'</strong> of '+CONFIG.goalWeeks+' ‚Äî <strong>'+Math.max(0,toGo).toFixed(1)+'</strong> lbs to go';
  document.getElementById('dashWeight').textContent = w.toFixed(1);
  const todayCal = data.calories.find(c=>c.date===today());
  document.getElementById('dashCalBudget').textContent = todayCal ? todayCal.target.toLocaleString() : calcTarget(w,'moderate').toLocaleString();
  const todayCheckin = data.checkins.find(c=>c.date===today());
  document.getElementById('dashStress').textContent = todayCheckin ? todayCheckin.stress+'/10' : '‚Äî';
  // Goal mode badge
  const modeBadge = document.getElementById('dashModeBadge');
  if (modeBadge) {
    const g = getGoal();
    const modeLabels = { loss: 'üî• Loss Mode ¬∑ 750 cal/day deficit', maintain: '‚öñÔ∏è Maintenance ¬∑ 200 cal/day deficit', gain: 'üí™ Gain Mode ¬∑ 300 cal/day surplus' };
    const modeColors = { loss: 'var(--accent-orange)', maintain: 'var(--accent-green)', gain: 'var(--accent-blue)' };
    modeBadge.textContent = modeLabels[g.mode];
    modeBadge.style.color = modeColors[g.mode];
  }
  const shabbatBadge = document.getElementById('dashShabbat');
  if (shabbatBadge) {
    const todayShabbat = todayCheckin && todayCheckin.shabbat;
    shabbatBadge.style.display = todayShabbat ? 'block' : 'none';
  }
  const todayW = data.workouts.filter(x=>x.date===today());
  document.getElementById('dashWorkout').textContent = todayW.length ? (todayW[todayW.length-1].type==='rest'?'Rest':todayW[todayW.length-1].rpe+'/10') : '‚Äî';
  const consumed = todayCal&&todayCal.log ? todayCal.log.reduce((s,f)=>s+f.calories,0) : 0;
  document.getElementById('dashConsumed').textContent = consumed ? consumed.toLocaleString() : '‚Äî';
  if (document.getElementById('dashConsumedBar')) document.getElementById('dashConsumedBar').textContent = consumed.toLocaleString();
  const burned = getTodayBurned();
  document.getElementById('dashBurned').textContent = burned ? burned.toLocaleString() : '‚Äî';
  const budget = todayCal ? todayCal.target : calcTarget(w, 'moderate');
  const remaining = budget + burned - consumed;
  document.getElementById('dashRemaining').textContent = remaining.toLocaleString();
  document.getElementById('dashRemaining').className = 'stat-value ' + (remaining >= 0 ? 'stat-green' : 'stat-red');
  // Balance bar
  const totalBudget = budget + burned;
  const balPct = totalBudget > 0 ? Math.min((consumed / totalBudget) * 100, 110) : 0;
  const balBar = document.getElementById('dashBalanceBar');
  const balLabel = document.getElementById('dashBalanceLabel');
  if (balBar) {
    balBar.style.width = Math.min(balPct, 100) + '%';
    balBar.classList.toggle('over', consumed > totalBudget);
    balLabel.textContent = consumed > totalBudget ? (consumed - totalBudget).toLocaleString() + ' cal over budget' : remaining.toLocaleString() + ' cal remaining';
    balLabel.style.color = consumed > totalBudget ? 'var(--accent-red)' : 'var(--accent-green)';
    balLabel.style.fontWeight = '700';
  }
  // Update dashboard macros
  const todayLog = todayCal && todayCal.log ? todayCal.log : [];
  const dashP = todayLog.reduce((s,f) => s + (f.protein||0), 0);
  const dashC = todayLog.reduce((s,f) => s + (f.carbs||0), 0);
  const dashF = todayLog.reduce((s,f) => s + (f.fat||0), 0);
  if (document.getElementById('dashProtein')) document.getElementById('dashProtein').textContent = dashP;
  if (document.getElementById('dashCarbs')) document.getElementById('dashCarbs').textContent = dashC;
  if (document.getElementById('dashFat')) document.getElementById('dashFat').textContent = dashF;
  renderWeekGrid(); renderNudge(todayCheckin); renderDashboardInsights();
}

function renderWeekGrid() {
  const g = document.getElementById('weekGrid'); const dn = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const now = new Date(); const sow = new Date(now); sow.setDate(now.getDate()-now.getDay());
  let h = '';
  for (let i=0;i<7;i++) {
    const d = new Date(sow); d.setDate(d.getDate()+i);
    // Use local date to avoid UTC timezone shift
    const ds = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
    const dayWorkouts = data.workouts.filter(w => w.date === ds);
    const icons = {weights:'üèãÔ∏è',cardio:'üö¥',stretch:'üßò',rest:'üõã'};
    // Show icon for most "active" workout if multiple
    let icon = '';
    if (dayWorkouts.length) {
      const priority = ['weights','cardio','stretch','rest'];
      const best = dayWorkouts.sort((a,b) => priority.indexOf(a.type) - priority.indexOf(b.type))[0];
      icon = icons[best.type] || '‚úì';
      if (dayWorkouts.length > 1) icon += '<span style="font-size:0.7rem;vertical-align:super">+' + (dayWorkouts.length-1) + '</span>';
    }
    h += '<div class="week-day '+(dayWorkouts.length?'completed':'')+' '+(ds===today()?'today':'')+'">' +
         '<div class="week-day-label">'+dn[i]+'</div>' +
         '<div class="week-day-icon">'+(icon || (ds===today()?'¬∑':''))+'</div></div>';
  }
  g.innerHTML = h;
}

function checkGoalReached() {
  const g = getGoal();
  const p = data.profile || { height: 68, age: 50 };
  const current = getCurrentWeight();
  if (g.mode === 'loss' && current <= g.goalWeight) {
    showToast('üéâüéâüéâ You reached your goal of ' + g.goalWeight + ' lbs! Time to set a new goal or switch to maintenance!');
  }
}

function renderNudge(checkin) {
  const b = document.getElementById('nudgeBanner'), t = document.getElementById('nudgeText');
  if (!checkin||checkin.stress<6) { b.classList.remove('visible'); return; }
  const nudges = [
    'Stress is elevated today. A 20-minute easy bike ride is one of the most effective cortisol reducers.',
    'High stress often leads to carb cravings. Front-load protein at your next meal to stay on track.',
    'Consider stretching or mobility today ‚Äî it reduces cortisol while keeping your streak alive.',
    'On high-stress days, even 15 min on the bike is a win. Don\'t skip ‚Äî scale back instead.',
    'Stress triggers comfort eating. Try protein first (Greek yogurt, eggs, nuts) to satisfy without the carb crash.'
  ];
  t.textContent = nudges[Math.floor(Math.random()*nudges.length)]; b.classList.add('visible');
}

function renderDashboardInsights() {
  const c = document.getElementById('insightsContainer'); const insights = [];
  const sorted = [...data.weights].sort((a,b)=>a.date.localeCompare(b.date));
  if (sorted.length >= 14) {
    const r7 = sorted.slice(-7), p7 = sorted.slice(-14,-7);
    const rA = r7.reduce((s,e)=>s+e.weight,0)/r7.length, pA = p7.reduce((s,e)=>s+e.weight,0)/p7.length;
    const wl = pA - rA;
    if (wl<0.5) insights.push({type:'warn',icon:'‚ö†Ô∏è',text:'Weight loss slowed to '+wl.toFixed(1)+' lbs/week. Consider increasing calorie adjustment to 10%.'});
    else if (wl>2.5) insights.push({type:'warn',icon:'‚ö°',text:'Losing '+wl.toFixed(1)+' lbs/week ‚Äî consider eating more to preserve muscle.'});
  }
  const streak = calcStreak();
  if (streak>=7) insights.push({type:'good',icon:'üî•',text:streak+'-day streak! Consistency is the #1 predictor of success.'});
  c.innerHTML = insights.map(i=>'<div class="insight-card insight-'+i.type+'"><span class="insight-icon">'+i.icon+'</span><span>'+i.text+'</span></div>').join('');
}

// ===== INSIGHTS =====
function refreshInsights() {
  const ws = new Date(Date.now()-7*86400000).toISOString().split('T')[0];
  const rw = data.weights.filter(w=>w.date>=ws).sort((a,b)=>a.date.localeCompare(b.date));
  if (rw.length>=2) { const ch=rw[rw.length-1].weight-rw[0].weight; const el=document.getElementById('insWeightChange'); el.textContent=(ch>0?'+':'')+ch.toFixed(1); el.className='stat-value '+(ch<=0?'stat-green':'stat-red'); }
  const ww = data.workouts.filter(w=>w.date>=ws&&w.type!=='rest');
  if (ww.length) document.getElementById('insAvgRPE').textContent = (ww.reduce((s,w)=>s+w.rpe,0)/ww.length).toFixed(1);
  document.getElementById('insWorkouts').textContent = data.workouts.filter(w=>w.date>=ws).length;
  const wc = data.checkins.filter(c=>c.date>=ws);
  if (wc.length) document.getElementById('insAvgStress').textContent = (wc.reduce((s,c)=>s+c.stress,0)/wc.length).toFixed(1);
  renderCorrelations();
  document.getElementById('currentStreak').textContent = calcStreak();
  document.getElementById('bestStreak').textContent = calcBestStreak();
  renderAdaptiveSuggestions();
}

function renderCorrelations() {
  const c = document.getElementById('correlationInsights'), nm = document.getElementById('noInsightsMsg');
  if (data.checkins.length<7) { c.innerHTML=''; nm.style.display='block'; return; }
  nm.style.display='none'; const ins = [];
  const hi = data.checkins.filter(x=>x.stress>=7), lo = data.checkins.filter(x=>x.stress<=3);
  if (hi.length>=3) { const hw=hi.filter(x=>data.workouts.some(w=>w.date===x.date&&w.type!=='rest')); const sr=Math.round((1-hw.length/hi.length)*100);
    if (sr>40) ins.push({type:'warn',icon:'üò§',text:'On high-stress days, you skip workouts '+sr+'% of the time. Even 15 min of easy cardio helps.'}); }
  const hc = hi.map(x=>data.calories.find(y=>y.date===x.date)).filter(Boolean);
  const pa = hc.filter(x=>x.adherence==='poor'||x.adherence==='ok');
  if (hc.length>=3&&pa.length/hc.length>0.5) ins.push({type:'warn',icon:'üçû',text:'On high-stress days, calorie adherence drops. Pre-plan protein-rich snacks.'});
  const hfl = hc.filter(x=>x.log&&x.log.length>0);
  if (hfl.length>=2) { const ac=hfl.reduce((s,x)=>s+x.log.reduce((ss,f)=>ss+(f.carbs||0),0),0)/hfl.length; const ap=hfl.reduce((s,x)=>s+x.log.reduce((ss,f)=>ss+(f.protein||0),0),0)/hfl.length;
    if (ac>ap*2) ins.push({type:'warn',icon:'üçû',text:'On stressed days, carb-to-protein ratio is '+(ac/ap).toFixed(1)+':1. Try protein-first meals.'}); }
  const ps = data.checkins.filter(x=>x.sleep<=2);
  if (ps.length>=3) { const ae=ps.reduce((s,x)=>s+x.energy,0)/ps.length; const aa=data.checkins.reduce((s,x)=>s+x.energy,0)/data.checkins.length;
    if (ae<aa-0.5) ins.push({type:'info',icon:'üò¥',text:'Poor sleep drops energy by '+(aa-ae).toFixed(1)+' points. Sleep may be the highest-leverage change.'}); }
  if (lo.length>=3) { const lw=lo.filter(x=>data.workouts.some(w=>w.date===x.date&&w.rpe>=6)); if (lw.length/lo.length>0.6) ins.push({type:'good',icon:'üí™',text:'On low-stress days you push harder (RPE 6+). Keep capitalizing!'}); }
  c.innerHTML = ins.length ? ins.map(i=>'<div class="insight-card insight-'+i.type+'"><span class="insight-icon">'+i.icon+'</span><span>'+i.text+'</span></div>').join('') : '<div class="insight-card insight-info"><span class="insight-icon">üìä</span><span>Keep logging daily for sharper pattern insights.</span></div>';
}

function renderAdaptiveSuggestions() {
  const c = document.getElementById('adaptiveSuggestions');
  if (data.weights.length<14) { c.innerHTML='<div class="insight-card insight-info"><span class="insight-icon">üìä</span><span>Keep logging ‚Äî after 2-3 weeks ToLife! will suggest adjustments.</span></div>'; return; }
  const sorted=[...data.weights].sort((a,b)=>a.date.localeCompare(b.date)); const r7=sorted.slice(-7),p7=sorted.slice(-14,-7);
  const rA=r7.reduce((s,e)=>s+e.weight,0)/r7.length, pA=p7.reduce((s,e)=>s+e.weight,0)/p7.length, wl=pA-rA; const sug=[];
  if (wl<0.5) sug.push({type:'warn',icon:'üéØ',text:'Plateau detected. Try: increase cal adjustment to 10%, add one extra cardio session, or reduce portion at largest meal.'});
  else if (wl>=1&&wl<=2) sug.push({type:'good',icon:'‚úÖ',text:'Losing '+wl.toFixed(1)+' lbs/week ‚Äî right on track!'});
  else if (wl>2.5) sug.push({type:'warn',icon:'‚ö°',text:'Losing '+wl.toFixed(1)+' lbs/week. Add 200 cal/day to protect muscle.'});
  c.innerHTML = sug.map(s=>'<div class="insight-card insight-'+s.type+'"><span class="insight-icon">'+s.icon+'</span><span>'+s.text+'</span></div>').join('');
}

// ===== STREAKS =====
function calcStreak() { let s=0,d=new Date(); while(true) { const ds=d.toISOString().split('T')[0]; if(!data.workouts.some(w=>w.date===ds)&&!data.checkins.some(c=>c.date===ds)&&!data.weights.some(w=>w.date===ds)) break; s++; d.setDate(d.getDate()-1); } return s; }
function calcBestStreak() { const ad=[...new Set([...data.workouts.map(w=>w.date),...data.checkins.map(c=>c.date),...data.weights.map(w=>w.date)])].sort(); let b=0,c=1; for(let i=1;i<ad.length;i++){if(daysBetween(ad[i-1],ad[i])===1)c++;else{b=Math.max(b,c);c=1;}} return Math.max(b,c,ad.length>0?1:0); }

// ===== DATA MANAGEMENT =====
function showDataModal() { document.getElementById('dataModal').classList.add('active'); }
function closeDataModal() { document.getElementById('dataModal').classList.remove('active'); }
async function exportData() {
  const jsonStr = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonStr], {type: 'application/json'});
  // Try modern File System API (lets user pick save location)
  if (window.showSaveFilePicker) {
    try {
      const handle = await showSaveFilePicker({
        suggestedName: 'tolife-backup-' + today() + '.json',
        types: [{ description: 'JSON', accept: {'application/json': ['.json']} }]
      });
      const writable = await handle.createWritable();
      await writable.write(blob);
      await writable.close();
      closeDataModal(); showToast('üì§ Saved!');
      return;
    } catch(e) { if (e.name === 'AbortError') return; }
  }
  // Fallback for Safari: old download method
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'tolife-backup-' + today() + '.json';
  a.click();
  URL.revokeObjectURL(a.href);
  closeDataModal(); showToast('üì§ Exported!');
}
function importData(ev) { const f=ev.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{try{const im=JSON.parse(e.target.result); if(im.weights&&im.workouts){data={myFoods:[],myWorkouts:[],myMeals:[],goal:null,goalHistory:[],profile:null,...im};saveData();closeDataModal(); showToast('üì• Imported!'); refreshDashboard();}}catch{showToast('‚ö†Ô∏è Error');}}; r.readAsText(f); ev.target.value=''; }
function resetAllData() { if(confirm('‚ö†Ô∏è Delete ALL data?')&&confirm('Really? Cannot be undone.')){ data={weights:[],workouts:[],checkins:[],calories:[],myFoods:[],myWorkouts:[],myMeals:[],startDate:today()}; saveData(); closeDataModal(); showToast('üóë Reset'); refreshDashboard(); } }

// ===== INIT =====
function init() {
  loadTheme(); loadData();
  const w=getCurrentWeight(); document.getElementById('calTarget').textContent=calcTarget(w,'moderate').toLocaleString();
  document.getElementById('calDetail').textContent='TDEE '+calcTDEE(w,'moderate').toLocaleString()+' ‚àí '+CONFIG.deficitPerDay+' deficit (with 5% adjustments)';
  const tc=data.checkins.find(c=>c.date===today());
  if(tc){document.getElementById('stressSlider').value=tc.stress;updateSlider('stress');setSleep(tc.sleep);document.getElementById('energySlider').value=tc.energy;updateSlider('energy');if(tc.note)document.getElementById('checkinNote').value=tc.note;
    if(tc.shabbat && document.getElementById('shabbatToggle')) document.getElementById('shabbatToggle').checked=true;
  } else {
    // Auto-suggest Shabbat on Friday
    const dow = new Date().getDay();
    if (dow === 5 && document.getElementById('shabbatToggle')) document.getElementById('shabbatToggle').checked = true;
  }
  const tw=data.weights.find(w=>w.date===today());
  if(tw){document.getElementById('checkinWeight').placeholder=tw.weight+' (logged)';} else {document.getElementById('checkinWeight').placeholder=getCurrentWeight().toFixed(1);}
  const tca=data.calories.find(c=>c.date===today());
  if(tca){currentActivity=tca.activity||'moderate';currentAdherence=tca.adherence||'';} else {currentAdherence='';}
  // Reset adherence button highlights for new day
  document.querySelectorAll('#adherenceSelect .quick-btn').forEach(b => b.classList.remove('active'));
  if(currentAdherence){
    const labels={'great':'üòä Great','good':'‚úÖ Good','ok':'‚ö†Ô∏è OK','poor':'‚ùå Poor'};
    document.querySelectorAll('#adherenceSelect .quick-btn').forEach(b => {
      if(b.textContent.trim()===labels[currentAdherence]) b.classList.add('active');
    });
  }
  document.getElementById('foodInput').addEventListener('keypress',e=>{if(e.key==='Enter')estimateCalories();});
  document.getElementById('dataModal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeDataModal();});
  if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});
  refreshDashboard();
}
init();
</script></body></html>
